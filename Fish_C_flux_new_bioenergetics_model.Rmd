---
title: High uncertainty in fish bioenergetics impedes precision of fish-mediated carbon transport estimates into the ocean's twilight zone
author: "Helena McMonagle"
date: "June 15, 2023"
output:
  word_document: default
  pdf_document: default
editor_options:  
  chunk_output_type: console
--- 
 
```{r add to YAML for PDF, include = FALSE}

# New users may need to install and load packages "systemfonts", "kable", "kableExtra", "knitr", "here", "MASS", "ggplot2", "tidyr", "dplyr"

library(knitr)
library(here)
library(mvtnorm)
library(qgam)
library(MASS)
library(tidyr)
library(dplyr)
library(stringr)
library(ggplot2)
library(quantreg)
library(ggh4x)
library(gcookbook)
library(tidytext)
library(RColorBrewer)
library(viridis) 

```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

Equations provided below for use in LaTeXiT app

$$
R_{O,i,j} = \alpha_0 + f(W) + g(T_{i,j}) + h(H_i)
$$

$$
f(W) = W^{\alpha_1}  
$$




$$
g(T_{i,j}) = \frac{\alpha_2 1000}{T_{i,j} + 273.15}
$$

$$
h(H_i) = \alpha_3 H_i
$$


### Respiration rate in units of energy utilization

$$
M = (24)(1 e ^{-6}) (1.429) \sum_{i=1}^{3} R_{O} Q_{ox} P_{i,j} A_{i,j} \theta
$$


### Adjusted routine metabolic rates based on activity



$$
P_{r} = 0.5
$$

$$
P_{m} = \frac{2 (D_{max} - D_{min})}{(3600)(24) S}
$$



$$
P_{f} = 1 - (P_{m} + P_{r})
$$


$$
I = \frac{G + M}{1 - (\phi_{SDA} + \phi_{F} + \phi_{X})}
$$


<!-- one option is to find I using the respiration rates and growth rates already established. Another is to use the I given in Palomares or Koehn papers (QB, i.e. consumption to biomass ratio). Note that Palomares and Pauly paper give QB in terms of daily %, so divide values in their table by 100 to get ratio in decimal form.  -->

QB_annual_Koehn <- 3
QB_annual_min_Palomares <- 0.0328*365
QB_annual_max_Palomares <- 0.103*365

QB_min_daily <- QB_annual_Koehn/365
QB_max_daily <- QB_annual_max_Palomares/365

<!-- The QB method indicates that a 1 g fish would consume between 0.008 and 0.1 g daily. comparable to method we used -->


### Respiratory flux


$$
C_{R,VM} = \frac{12 R_Q E_{M}}{32Q_{ox}} 
$$

Note: The constant 32 converts from grams to moles of oxygen, and there is a 1:1 conversion between moles of carbon dioxide and carbon. The constant 12 converts from moles of carbon to grams of carbon. Although the code has Q_ox here as kJ/g, so that there's no need to multiply by 1000 in the equation shown to convert from g to mg, in the code Qox is shown as 13.4 kJ/g and there's a 1000 constant to convert from g to mg. 

$$
E_{M} = M_{VM,r} + M_{VM, m} (1 - \frac{B - D_{min}}{D_{max} - D_{min}})
$$

$$
C_{R,NM} = \frac{12 R_Q M_{NM, t} Z}{32 Q_{ox}}
$$

Note: W indicates wet mass of the individual fish, in mg (e.g. for a 1 g fish, used for the figures in the main text, we entered 1000 mg for W)

### SDA flux


$$
C_{SDA, VM} = \frac{12 R_Q \phi_{SDA} \; E_{SDA} \;I} {32 Q_{ox}}
$$

$$
C_{SDA,NM} = \frac{12R_Q\phi_{SDA}\;I\;Z}{32Q_{ox}}
$$

Note that some of the SDA equations are in supplementary information

$$
\int_{0}^{24P_f + \tau} p(t) dt
$$

$$
\tau = \frac{24P_m\frac{B - D_{min}}{D_{max} - D_{min}}}{2}
$$

$$
f(t_{meal}) = \int_{0}^{24P_f + \tau - t{meal}} p(t) dt
$$


$$
E_{SDA} = \int_{0}^{24P_f} g(t_{meal})(1-f(t_{meal})) dt_{meal}
$$

$$
E_{SDA} = \int_{0}^{24P_f}1-f(t_{meal}) dt_{meal}
$$

### Egestion flux


$$
C_{F, VM} = \frac{\phi_{F} I C_{p} E_{F}}{4.184 e_{p}}
$$


$$
C_{F, NM} = \frac{\phi_{F} I C_{p} Z}{4.184 e_{p}}
$$


### Excretion flux

From Wilson et al 2009 refs therein: excretion = 18-40umol C /hr/g wet weight of fish. This equates to about 0.00835 mgC/d, or 0.00000835 gC/d. 

```{r calculate excreted C in mgC/d, echo = FALSE}

# Wilson et al. 2009 give excreted carbon in umol/kg fish. 
# to convert from kg to g, this would be nmol/g. 

calculate_X_in_mgC <- function(nmolC){
  mgC <- nmolC/1000000000*12*1000*24 # divide by 1000umol per mol, multiply by 12 g/molC, 
  # multiply by 1000mg/g, multiply by 24 hr/d
  return(mgC)
}

# mean, in mgC/d
mean_nmolC = (18+40)/2
calculate_X_in_mgC(nmolC=mean_nmolC) # 0.00835 mgC/d, or 
calculate_X_in_mgC(nmolC=mean_nmolC)/1000 # 0.00000835 gC/d

# note that a 1 g VM fish transports about 0.003 gC/d, so this is very small in comparison, only about 0.3%!
(0.00000835/0.003)*100

```

$$
C_{X, VM} = X_r E_X 
$$

$$
C_{X, NM} = X_r Z
$$

### Mortality flux

$$
log_{10}(\mu) = a_0 + a_1 log_{10}(L_{\infty}) + a_2log_{10}(K) + a_3log_{10}(T_{mean}) 
$$

$$
C_{\mu,VM} = E_{\mu} C_c W (1- e^{-\mu \frac{1}{365}})
$$
$$
C_{\mu,NM}=Z C_c W (1- e^ {-\mu \frac{1}{365}})
$$

### Total fish-mediated carbon flux for vertically migrating and non-migrating fish
<!-- don't need to include this equation written out--just explain in words -->

$$
C_{total,i} = C_{R,i} + C_{SDA,i} + C_{F,i} + C_{X,i} + C_{mu,i}
$$

## Informing the bioenergetics model with data


```{r table of parameters, echo = FALSE}
# library(kableExtra) 

# Table 1 code

parameters <- read.csv(here("data", "parameters.csv"), header = TRUE)

par_symbols <- c(
  "$\\alpha_0$",
  "$\\alpha_1$",
  "$\\alpha_2$",
  "$\\alpha_3$",
  "$H$",
  "$T_{epi}$",
  "$T_{meso}$",
  "$T_{mean}$",
  "$R_{O}$",
  "$A_{r}$",
  "$A_{m}$",
  "$A_{f}$",
  "$P_{r}$",
  "$P_{m}$",
  "$P_{f}$",
  "$M$",
  "$I$",
  "$G_{VM}$",
  "$G_{NM}$",
  "$\\phi_{SDA}$",
  "$\\phi_{F}$",
  "$\\phi_{X}$",
  "$\\theta$",
  "$Z$",
  "$E_{M}$",
  "$C_{R, VM}$",
  "$C_{R, NM}$",
  "$t_{peak}$",
  "$t_{90}$",
  "$E_{SDA}$",
  "$C_{SDA, VM}$",
  "$C_{SDA, NM}$",
  "$E_{F}$",
  "$C_{F,VM}$",
  "$C_{F,NM}$",
  "$E_{X}$", 
  "$X_{r}$",  
  "$C_{X, VM}$",
  "$C_{X, NM}$",
  "$L_{infinity}$",
  "$K$",
  "$a_0$",
  "$a_1$",
  "$a_2$",
  "$a_3$",
  "$\\mu$",
  "$C_{\\mu ,VM}$",
  "$C_{\\mu ,NM}$",
  "$Q_{ox}$",
  "$RQ$",
  "$D_{max}$",
  "$D_{min}$",
  "$B$",
  "$S$",
  "$e_{p}$",
  "$C_{p}$",
  "$C_{c}$",
  "$E_{\\mu}$"
)

rownames(parameters) <- par_symbols

kable(parameters, caption = "Fish-mediated carbon flux parameters. The variables used in equations 1 through 12 are described above with their mean or nominal value, range, units, and citation where applicable. Blank mean values indicate that the value was calculated based on other input parameters, blank ranges indicate that the value entered is a constant and not allowed to vary in sensitivity analyses, and blank units indicate that the parameter is unitless. Parameters apply to both vertically migrating (VM) fish and non-migrating (NM) fish unless otherwise noted.", escape = FALSE) 

```

## Sensitivity analyses

# Results


### Respiration regression, excluding epipelagic fish from Ikeda 2016. Put into supplementary information. Reformat figures and regression summary output. 

```{r plot regression model and dignostics, fig.width=7, fig.height=4, echo = FALSE}

# Here we re-ran the Ikeda 2016 regression with only mesopelagic fish, and with habitat depth as a categorical variable, but used 3 different depth categories (shallow VM, deep VM, NM) based on minimum habitat depth where shallow VM fish migrated as shallow as 1-50m and deep VM fish migrating only as shallow as 50-150m. Any fish that migrated no shallower than 150m was considered a NM fish. The predictors have not been centered here, to allow easier direct comparison with Ikeda 2016 results (where both mesopelagic fish and other pelagic fish are used to fit the regression model)
#resp_model_3_depths <- lm(log(R) ~ log(mgWM) + Temp_var + Cat_depth, resp_data)
#summary(resp_model_3_depths)
# only the NM category is significantly different from the VM_long category (reference category), so edited the habitat categorical data coding and re-ran regression, now with just 2 different depth categories (NM or VM). 

# load data 
resp_data <- read.csv(here("data", "Ikeda_2016_data_VM_NM.csv"), header = TRUE)

# make the categorical depth category a factor
resp_data$Cat_depth <- as.factor(resp_data$Cat_depth)

# re-calculate temp data as in Ikeda 2016 (take inverse, multiple by 1000, and convert to K)
Tref <- 15 # Reference temperature (same as used in C flux function)
Wref <- 1000 # Reference fish wet mass (same as used in C flux function)
resp_data$Temp_var <- 1000/(resp_data$Temp_C + 273.15) # original temperature predictor
resp_data$Temp_var_T_ref <- 1000/(resp_data$Temp_C + 273.15) - 1000/(Tref+ 273.15) # modification for centering at Tref
resp_data$logW_ref <- log(resp_data$mgWM) - log(Wref) # modification for centering at Wref
# Note: only need to center temp and fish mass because these are the only two continuous predictors (habitat depth is categorical)

# fit linear regression (with log-log transformation for respiration rate and fish wet mass)
resp_model <- lm(log(R) ~ log(mgWM) + Temp_var + Cat_depth, resp_data)
resp_model_center <- lm(log(R) ~ logW_ref + Temp_var_T_ref + Cat_depth, resp_data)

# summary
summary(resp_model)
summary(resp_model_center)

# variance-covariance matrix
Sigma_resp_model_old <- vcov(resp_model)
Sigma_resp_model_center <- vcov(resp_model_center)

# best fit model coefficients 
resp_model_coeff <- coefficients(resp_model)
resp_model_coeff_center <- coefficients(resp_model_center)

# coefficients generated from mvrnorm (we won't use this in final results, use centered model, 
# but the non-centered model should match fairly closely with Ikeda results with the cause of any differences being
# that we used a categorical habitat depth predictor and subsetted to include only mesopelagic fish

nsims <- 1000
coeff_table <- mvrnorm(n = nsims, mu = resp_model_coeff, Sigma = Sigma_resp_model_old)

# create data frame for just mass and respiration rate (not centered)
resp_regression_SI <- as.data.frame(cbind(mass=log(resp_data$mgWM), resp =log(resp_data$R)))

# plot
plot_mass_resp_rate <- ggplot(data = resp_regression_SI, aes(x = mass, y = resp)) +
     geom_point() +
     geom_smooth(method = "lm", alpha = .15, colour = "#21918c", fill = "#21918c", level = 0.95) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), strip.text.x = element_text(size = 16), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 16)) + 
  xlab(bquote("\n Ln wet mass (mg)")) + 
  ylab(bquote("Ln respiration rate (ul O2 per individual per hour) \n")) 

plot_mass_resp_rate

# next make same plot, but with centered temp and mass predictors

# create data frame for just mass and respiration rate (centered)
resp_regression_SI_center <- as.data.frame(cbind(mass=resp_data$logW_ref, resp =log(resp_data$R)))

# plot centered regression
plot_mass_resp_rate_center <- ggplot(data = resp_regression_SI_center, aes(x = mass, y = resp)) +
     geom_point() +
     geom_smooth(method = "lm", alpha = .15, colour = "#21918c", fill = "#21918c", level = 0.95) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), strip.text.x = element_text(size = 20), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 20)) + 
  xlab(bquote("\n Centered natural log of wet mass (mg)")) + 
  ylab(bquote("Natural log of respiration rate \n (microliters oxygen per individual per hour) \n")) 

plot_mass_resp_rate_center

# centered coeff table
coeff_table_center <- mvrnorm(n = nsims*2, mu = resp_model_coeff_center, Sigma = Sigma_resp_model_center)


## Diagnostics ##

## set plot area
par(mai = c(0.9, 0.9, 0.6, 0.1),
    omi = c(0, 0, 0, 0),
    mfrow = c(1,2), cex.lab = 1.2)

## qq resids
qqnorm(residuals(resp_model), main = "QQ plot (residuals)", las = 1, pch = 16)
qqline(residuals(resp_model))

## residuals vs fitted
plot(fitted(resp_model), residuals(resp_model), las = 1, pch = 16,
     xlab = "Fitted", ylab = "Residuals",
     main = "Residuals vs fitted")
abline(h=0, lty = "dashed")

ggplot(data = )

```


## Monte Carlo simulation 
```{r 1g C flux function for VM fish, echo = FALSE}

# Functions to use inside C.flux.function.VM, for finding SDA flux

# Main function. pSDA is the proportion of exported SDA, called SDAe in manuscript. 
calc.pSDA <- function(pars) {
  
  # temporarily turn off warnings that are annoying
  defaultW <- getOption("warn")
  options(warn = -1)
  
  peakTime <- pars$peakTime
  timeTo90 <- pars$timeTo90
  tmax <- pars$tmax
  tau <- pars$tau
  estGamma <- function(peakTime, timeTo90) {
    setOptim <- function(logalpha, peakTime, timeTo90) {
      alpha <- exp(logalpha) + 1 # adding 1 ensures that peak is not at 0
      beta <- (alpha - 1) / peakTime
      estTimeTo90 <-
        qgamma(0.90,
               shape = alpha,
               rate = beta,
               lower.tail = TRUE)
      return((timeTo90  - estTimeTo90) ^ 2)
    }
    
    #### estimate alpha and beta based on peakTime and timeTo90 ####
    log.alpha.start <- 5
    fit <- optim(
      par = log.alpha.start,
      fn = setOptim,
      method = "Brent",
      lower = -200,
      upper = 200,
      peakTime = peakTime,
      timeTo90 = timeTo90
    )
    alpha <- exp(fit$par) + 1
    beta <- (alpha - 1) / peakTime
    return (c(alpha = alpha, beta = beta))
  }
  
  #### function to return F(tmeal) ####
  foft <- function(tmeal, alpha, beta, tmax, tau) {
    if (tmeal == 0)
      return(dunif(tmeal, min = 0, max = tmax))
    if (tmeal > 0)
      return(dunif(tmeal, min = 0, max = tmax) * (
        1 - pgamma(
          tmax + tau - tmeal,
          shape = alpha,
          rate = beta,
          lower.tail = TRUE
        )
      ))
  }
  #### End of Subfunction Creation ####
  
  ### Use functions to calculate integral
  
    gammaPars <- estGamma(peakTime, timeTo90)
    alpha <- gammaPars["alpha"]
    beta <- gammaPars["beta"]
   
    pSDA <-
      tmax / 6 * (foft(tmeal = 0, alpha, beta, tmax, tau) + 
                      4 * foft(tmeal = tmax / 2, alpha, beta, tmax, tau) + 
                      foft(tmeal =tmax, alpha, beta, tmax, tau)
      )
    # turn warnings back to default
    options(warn = defaultW)
    return(pSDA)
}



#=================VM fish flux function==============================

C.flux.function.VM <- function(W_w_f_VM, Wref, Tref, a0, a1, a2, a3, H_VM_or_NM, TT_epipelagic, TT_mesopelagic, TT_mean, activity_factor_resting, activity_factor_migrating, activity_factor_foraging, time_resting, Dmax, Dmin, B, S, prop_SDA, prop_egestion, prop_excretion, G_VM, theta, peakTime, timeTo90, Q_ox_kJ_g_O2, RQ, energy_in_pellet, C_in_pellet,  proportion_egestion_below_150m, X_r, X_e, mu, C_c_vm, prop_mortality_below_150m) {

  # Notes on Tref and Wref arguments above:
  # Tref <- 15 # Reference temperature (same as used in C flux function)
  # Wref <- 1000 # Reference fish wet mass (same as used in C flux function)
  # Pass these values in the MC function that comes later. 
  
  # Equations 1 and 2: oxygen utilization

  # center regression on reference fish weight (Wref) and reference temperature (Tref), done to avoid strong covariance 
  # between intercept and slope
  R_O_VM_r <- exp(a0 + a1* (log(W_w_f_VM*1000) - log(Wref)) + a2 * (1000/(TT_mesopelagic+273.15) - 1000/(Tref + 273.15)) + a3 * H_VM_or_NM) # ul O2/ind / hour. Raised both sides by e to remove the ln() before respiration rate on the left side of equation

  R_O_VM_m <- exp(a0 + a1 * (log(W_w_f_VM*1000) - log(Wref)) + a2 * (1000/(TT_mean+273.15) - 1000 /(Tref + 273.15)) + a3 * H_VM_or_NM)
  
  R_O_VM_f <- exp(a0 + a1 * (log(W_w_f_VM*1000) - log(Wref)) + a2 * (1000/(TT_epipelagic+273.15) - 1000 / (Tref + 273.15)) + a3 * H_VM_or_NM) 
  
  # Equations 3 and 4: energy expenditure due to non-SDA metabolism for each daily activity cycle.
  # Convert from units of O2 to energy, and from per hour to per day, for each part of daily cycle
  
  # find time (proportion of a day) spent in each behavior
  # time resting will be 0.5 nominally but allowed to vary in sensitivity analysis
  t_m <- 2 * (Dmax - Dmin) / ((S/100)*(60*60*24)) # S= about 5 cm/s, or 0.05 m/s)
  t_f <- 1 - (t_m + time_resting) 
  
  # Calculate energy expenditure for each behavior in a daily cycle (resting, migrating, foraging)
  R_VM_r <- 24 * .000001 * 1.429 * R_O_VM_r * Q_ox_kJ_g_O2 * time_resting *
    activity_factor_resting * theta
  R_VM_m <- 24 * .000001 * 1.429 * R_O_VM_m * Q_ox_kJ_g_O2 * t_m *
    activity_factor_migrating * theta
  R_VM_f <- 24 * .000001 * 1.429 * R_O_VM_f * Q_ox_kJ_g_O2 * t_f *
    activity_factor_foraging * theta
  
   # Units are now in kj/day, converted by multiplying resp rate for 1 individual * 24 hr/day * 1 ml / 1000 ul * 1 L / 1000 ml * Qox in kcal / L O2 * 4.184 kJ / kcal)

  # Sum all 3 activities to get daily energy expended on non-SDA metabolism per day
  R_VM_daily <- R_VM_r + R_VM_m + R_VM_f
  
  # Equation 5: energy ingested (kJ/d)
  I_VM <- (G_VM + R_VM_daily) / (1 - (prop_SDA + prop_egestion + prop_excretion))
  
  # Equation 6 and 7: C flux from respiration (note; equation numbers differ in manuscript due to moving some material to supplement)
  
  # Calculate proportion of respired carbon that is exported
  R_exported_VM = R_VM_m * (1- ((B-Dmin) / (Dmax - Dmin))) + R_VM_r 
  
  # Convert from units of energy, to units of oxygen, to units of carbon
  C_r_VM = 12 * RQ * 1000 * R_exported_VM / (32 * Q_ox_kJ_g_O2)
  
  # units: kj/day respired and exported * (1 g O2 / 13.4 kJ from Jobling 1994) * (mol O2 / 32 g O2) * respiratory quotient * (1 mol C / 1 mol CO2) * (12 g C / mol C) * 1000 to convert g C to mg C
  
  # The constant 32 converts from grams to moles of oxygen, and there is a 1:1 conversion between moles of carbon dioxide and carbon. The constant 12 converts from moles of carbon to grams of carbon, and 1000 converts from grams of carbon to milligrams (W_w_f_VM is entered earlier as 1 for a 1 g fish)
  
  # Equation 8.5a  C flux from SDA
  # Some parts of these calculations are explained in greater detail in supplementary info. 

  # time between when fish starts and ends foraging
  tmax <- 24*t_f
  
  # time after feeding ends that fish crosses flux boundary
  tau <- (B-Dmin) / (Dmax-Dmin) * 24 * t_m * .5
  
  # make object containing parameters for SDA flux calculations
  pars <- list(peakTime = peakTime,
             timeTo90 = timeTo90,
             tmax = tmax,
             tau = tau) 
  
  # find proportion of respired energy lost to SDA that is exported
  SDA_exported <- calc.pSDA(pars)
  
  # convert to C flux per day lost to SDA below flux boundary
  C_SDA_VM <- (12 * RQ * 1000 * prop_SDA * SDA_exported * I_VM) / 
    (32 * Q_ox_kJ_g_O2)
  # 1000 converts from g to mg (no need to multiply by W_w_f because )
  
  # Equation 8.5b: SDA flux for NM fish (NM fish function is a separate function).

  
  # Equation 9: egestion flux
  
  ## Assume that 75-100% of carbon released as fecal pellets ends up below flux boundary. Fecal pellets are thought to be released during daytime depth, due to slow rate of gut evacuation (slow compared to zooplankton), and even if released above flux boundary, presumably most would sink below flux boundary before remineralization. Minimum flux here assumes that 25% gets released above the flux boundary and is remineralized before reaching deeper than flux boundary.

  # Amount of carbon released below flux boundary also depends on carbon content of total energy lost from egestion. Use published caloric value of fish fecal pellets: 0.6-3.5 kcal/g in Bailey and Robertson 1982, or 2.7 kcal/g mentioned in Brett and Groves 1979. convert kj --> kcal --> g --> POC content
  # from Saba and Steinberg 2012: pellet C content ranged from 15 ug C / pellet to 31 ug C / pellet, and avg pellet size was 314 ug (dry weight). So, range is 15 ug C / 314 ug pellet DW to 31 ug C / 314 ug pellet DW, or 0.05-0.1 g C / g DW pellet.
  
  C_f_VM <- proportion_egestion_below_150m * I_VM* (1/4.184) * (1/energy_in_pellet) * C_in_pellet * proportion_egestion_below_150m * 1000 # egested energy F_VM, in kj/day/ind, * (kcal/ 4.184 kJ) * (g DW /0.6-3.5 kcal) (0.05-0.10 g C / g DW pellet), then 1000 converts from g to mg 
  # In sensitivity analyses, we allow energy_in_pellet to vary from 0.6-3.5 kcal/ g DW. Make C_p (carbon in pellet) vary from 0.05-0.10 g C/g DW. 
  
  # Equation 10 finds egestion flux for NM fish.
  
  # Equation 10.1: excretion flux
  C_X_VM <- X_r * X_e # nominal value of 0.008 is in mgC per day, so no need to multiply this flux by 1000 to convert from g to mg. 
  
  # Equation 10.2 finds excretion flux for NM fish
  
  # Equation 11: mortality flux
  
  # Pauly 1980 mortality rate regression:
  # set mu as a constant based on aa0, aa1, aa2, aa3, K, and Linfinity from lit but 
  # only allow mu to vary in sensitivity analysis 
  # This allows us to determine overall sensitivity of C flux to mu
  # mu <- exp(aa0 - aa1*log(Linfinity) + aa2*log(K) + aa3*log(TT_mean))
  # kJ/d * g C / g wet mass of fish * g wet mass of fish / kJ * 1000 mg / g
  # mg C /d = 1 g fish * g C/g fish * rate in units per day * 1000 mg / g
  C_mu_VM <- prop_mortality_below_150m * C_c_vm * (1 - exp(-mu/365)) * 1000 * W_w_f_VM
  
# # in paper, we use C_c units of mg C / g fish wet mass, to avoid needing the 1000 constant in the equation, but in the code we just multiply by 1000 and keep this is mg C / mg fish wet mass
  
  # Final equation 
  # Not a numbered equation because easily described in text
  
  # Add C_r, C_f, C_m and C_x together 
  C_vm_tot <- C_r_VM + C_SDA_VM + C_f_VM + C_X_VM + C_mu_VM # mg C / ind / day (so a 1g fish is on avg transporting something like 1 mg C per day)

# Note that this value can be treated as a rough average--it does not account for seasonality. If desired, could multiply by 365 to get an approximate annual carbon flux rate. 

  return(c(C_vm_tot, C_r_VM, C_SDA_VM, C_f_VM, C_X_VM, C_mu_VM, I_VM))
}


```


```{r 1g C flux function for NM fish, echo = FALSE}

#=================NM fish flux function==============================

C.flux.function.NM <- function(W_w_f_NM, Wref, Tref, a0, a1, a2, a3, H_VM_or_NM, TT_mesopelagic, TT_mean, activity_factor_resting, activity_factor_foraging, time_resting, prop_SDA, prop_egestion, prop_excretion, G_NM, theta, X_r, mu, Q_ox_kJ_g_O2, RQ, prop_non_detrital_NM_prey, energy_in_pellet, C_in_pellet, C_c_nm) {

  # Equations 1 and 2
  # Find oxygen utilization, which is dependent on mass of individual, temp of water and habitat type). Use Ikeda 2016 (in ul O2/ind/hr) for all fish, but with modifications to exclude mesopelagic fish and to account for NM or VM fish in the habitat depth predictor

  # write out in log space then exponentiate. pass Wref and Tref earlier so they work in this function. do same for VM and NM fish 
  
  R_O_NM_r <- exp(a0 + a1* (log(W_w_f_NM*1000) - log(Wref)) + a2 * (1000/(TT_mesopelagic+273.15) - 1000/(Tref + 273.15)) + a3 * H_VM_or_NM) # ul O2/ind / hour. Raised both sides by e to remove the ln() before respiration rate on the left side of equation
  
  R_O_NM_f <- R_O_NM_r # baseline respiration rate (before accounting for difference in activity level) is the same during foraging and resting for NM fish (unlike for VM fish where the temperature used is different during resting, foraging and migrating)
  
    
  # Equation 3 and 4: convert from units of O2 to energy, and from per hour to per day, for each part of a daily cycle
  
  # find time (proportion of a day) spent in each behavior
  # time resting will be 0.5 nominally but allowed to vary in sensitivity analysis
  t_f <- 1 - time_resting
  
  # Calculate energy expenditure for each behavior in a daily cycle (resting, migrating, foraging)
  R_NM_r <- 24 * .000001 * 1.429 * R_O_NM_r * Q_ox_kJ_g_O2 * time_resting *
    activity_factor_resting * theta
  R_NM_f <- 24 * .000001 * 1.429 * R_O_NM_f * Q_ox_kJ_g_O2 * t_f * 
    activity_factor_foraging * theta

  # Sum all 2 activities to get daily energy expended on metabolism
  R_NM_daily <- R_NM_r + R_NM_f # total energy expenditure per day

  # kj/day, converted by multiplying resp rate for 1 individual * 24 hr/day * 1 ml / 1000 ul * 1 L / 1000 ml * Qox in kcal / L O2 * 4.184 kJ / kcal)
    
  
  # Equation 5: energy ingested (kJ/d)
  I_NM <- (G_NM + R_NM_daily) / (1 - (prop_SDA + prop_egestion + prop_excretion))

  
  # Equation 8
  # Find respiratory flux of NM fish

  ## amount of carbon released: convert from kj/day to O2 util/day to C released /day for each individual
  
  C_r_NM = R_NM_daily * prop_non_detrital_NM_prey * (1/Q_ox_kJ_g_O2) * (1/32) * RQ * 12 * 1000
  
  # kj/day respired and exported * (1 g O2 / 13.4 kJ from Jobling 1994) * (mol O2 / 32 g O2) * respiratory quotient * (1 mol CO2 / 1 mol O2) (1 mol C / 1 mol CO2) * (12 g C / mol C) * 1000 to convert g C to mg C
  
    # Equation 8.5b
  # Find C flux from SDA
  C_SDA_NM <- 12 * 1000 * RQ * prop_SDA * I_NM * prop_non_detrital_NM_prey * (1/32) * (1/Q_ox_kJ_g_O2)
  
  
  # Equation 10
  # Find C flux from egestion
   # For NM fish, assume 100% of carbon egested is released > 150 m, but that amount is reduced by multiplying by Z (proportion of zooplankton of non-detrital prey)
  
  C_f_NM <- 1000 * prop_egestion * C_in_pellet * prop_non_detrital_NM_prey * I_NM * (1/4.184) * (1/energy_in_pellet)
  
    # energy lost to ingestion in kj/day/ind * (kcal/ 4.184 kJ) * (g DW /0.6-3.5 kcal) (0.05-0.10 g C / g DW pellet)

  
  # Equation 10.2 finds excretion flux for NM fish
  
  C_X_NM <- X_r * prop_non_detrital_NM_prey # nominal value of 0.008 is in mgC per day, so no need to multiply this flux by 1000 to convert from g to mg. 
  
 # Equation 12
  # Find C flux from mortality
    C_mu_NM <- prop_non_detrital_NM_prey * C_c_nm * (1 - exp(-mu/365)) * W_w_f_NM * 1000 
    
  # Assumes 100% of NM fish mortality (predation too) occurs > 150 m. 

  # Final equation 
  # Not a numbered equation because easily described in text
  
  # Add C_r, C_SDA, C_f, C_X, and C_mu together
  C_nm_tot <- C_r_NM + C_SDA_NM + C_f_NM + C_X_NM + C_mu_NM # mg C / ind / day (so a 1g fish is on avg transporting something like 2 mg C per day)

 # energy ingested (for checking estimate makes sense) = I_NM

# Note that this value can be treated as a rough average--it does not account for seasonality. If desired, could multiply by 365 to get an approximate annual carbon flux rate. 

  return(c(C_nm_tot, C_r_NM, C_SDA_NM, C_f_NM, C_X_NM, C_mu_NM, I_NM))
}

```



```{r Monte Carlo function VM fish, echo = FALSE}

## Monte Carlo simulation for VM fish carbon flux
## Note that this returns two data frames within a list. The first data frame contains the total C flux and the parameter vectors for each simulation, and a second df contains the total C flux as well as the C flux associated with each carbon pathway (resp, SDA, egestion, etc.) for each simulation.
# Enter W_w_f in g and Wref in mg
MC_func_VM <- function(nsims, W_w_f_VM, Tref, Wref) {
  output <- rep(NA, nsims)
  W_w_f_VM <- W_w_f_VM # set this in argument of MC_func_VM
  
# use Ikeda 2016 values for regression of both VM and NM fish 
  # made range the mean +/- 2 SE 
  
# Variance-covariance matrix, for limiting MC draws for intercept and slope to only appropriate values based on fit to data
  
  # set seed for reproducibility
  set.seed(123)
  
  # load data 
  resp_data <- read.csv(here("data", "Ikeda_2016_data_VM_NM.csv"), header = TRUE)
  
  # make the categorical depth category a factor
  resp_data$Cat_depth <- as.factor(resp_data$Cat_depth)
  
  # re-calculate temp data as in Ikeda 2016 (take inverse, multiple by 1000, and convert to K)
  resp_data$Temp_var <- 1000/(resp_data$Temp_C + 273.15) # original temperature predictor
  resp_data$Inv_Temp_var <- 1000/(resp_data$Temp_C + 273.15) - 1000/(Tref+ 273.15) # modification for centering at Tref
  resp_data$logW_ref <- log(resp_data$mgWM) - log(Wref) # modification for centering at Wref
  # Note: only need to center temp and fish mass because these are the only two continuous predictors (habitat depth is categorical)
  
  # fit linear regression (with log-log transformation for respiration rate and fish wet mass)
  resp_model <- lm(log(R) ~ log(mgWM) + Temp_var + Cat_depth, resp_data)
  
  # same model but with centered temp and mass predictors
  resp_model_center <- lm(log(R) ~ logW_ref + Inv_Temp_var + Cat_depth, resp_data)
  
  # regression summaries for old model and new, centered model
  summary(resp_model)
  summary(resp_model_center) # use this model (centered, so less covariance between intercept and coefficients of predictors)
  
  # variance-covariance plot
  Sigma_resp_model_old <- vcov(resp_model)
  Sigma_resp_model_center <- vcov(resp_model_center)
  
  # best fit model coefficients 
  resp_model_coeff <- coefficients(resp_model)
  resp_model_coeff_center <- coefficients(resp_model_center)
  
  # generate twice as many values as needed for each coefficient (so that, after filtering,
  # there will still be sufficient values for use in the Monte Carlo simulation)
  # use centered regression
  coeff_table_unfiltered_c <- mvrnorm(n = nsims*2, mu = resp_model_coeff_center, Sigma = Sigma_resp_model_center) # _c = centered
  
  # coerce into data frame 
  coeff_table_unfiltered_df_c <- as.data.frame(coeff_table_unfiltered_c)
  
  # edit column names
  colnames(coeff_table_unfiltered_df_c) <- c("Intercept", "log.Wref", "TempRef", "Depth.VM")
  
  # pull out just the standard errors
  std_errors <- summary(resp_model_center)$coefficients[, 2]
  
  ### code to add respiration rate coefficient thresholds ###
  
  # We need to filter out a few extreme values that create unrealistic results (to avoid unrealistic results). To do this, we first centered the regression on reference temp and fish mass values, which removes much of the covariance that otherwise occurs between the intercept and slope of the regression. Next, we constrain the variance for each parameter, treating each parameter as univariate (rather than multivariate, which we were doing before centering the regression due to high covariance). Below this is done by constraining each predictor within +/- 2 standard errors. 
  
  # filter out any values greater than 2 SE from the mean coefficient value (removes ~5% of values)
  all_intercepts <- coeff_table_unfiltered_df_c$Intercept[
    -which(abs(coeff_table_unfiltered_df_c$Intercept-resp_model_coeff_center[1]) > std_errors[1]*2)]
  all_mass_coeff <- coeff_table_unfiltered_df_c$log.Wref[
    -which(abs(coeff_table_unfiltered_df_c$log.Wref-resp_model_coeff_center[2]) > std_errors[2]*2)]
  all_temp_coeff <- coeff_table_unfiltered_df_c$TempRef[
    -which(abs(coeff_table_unfiltered_df_c$TempRef-resp_model_coeff_center[3]) > std_errors[3]*2)]
  all_depth_coeff <- coeff_table_unfiltered_df_c$Depth.VM[
    -which(abs(coeff_table_unfiltered_df_c$Depth.VM-resp_model_coeff_center[4]) > std_errors[4]*2)]
  # samples 1000 values from this vector of filtered values (all with equal chance of being
  # selected)
  # shouldn't matter much whether replace = TRUE or FALSE, if there are sufficient values remaining to sample when replace = FALSE
  a0.vec <- sample(x = all_intercepts, size = nsims, replace = FALSE)
  a1.vec <- sample(x = all_mass_coeff, size = nsims, replace = FALSE)
  a2.vec <- sample(x = all_temp_coeff, size = nsims, replace = FALSE)
  a3.vec <- sample(x = all_depth_coeff, size = nsims, replace = FALSE)
  
  # check what % of values were filtered out
  100-(length(all_intercepts)/length(coeff_table_unfiltered_df_c$Intercept)*100)
  # approximately 5% filtered out, as we would expect constraining +/- 2 SE
  
  ### end of code to add respiration rate coefficient thresholds ###
  
  
  H_VM_or_NM.vec <- runif(nsims, min = 1, max = 1) # use 1 for VM fish or 0 for NM fish function 
  TT_epipelagic.vec <- runif(n = nsims, min = 14-5, max = 14+5) # +/- 1 degrees from measured epipelagic temp in EXPORTS location. Adjust based on environment modeled
  TT_mesopelagic.vec <- runif(n = nsims, min = 11-5, max = 11+5) # +/- 1 degrees from measured mesopelagic temp in EXPORTS location. Adjust based on environment modeled
  TT_mean.vec <- runif(n = nsims, min = 12.5-5, max = 12.5+5) # +/- 1 degrees from measured mean(mean(epipelagic), mean(mesopelagic)) temp in EXPORTS location. Adjust as needed

  activity_factor_resting.vec <- runif(nsims, min = 0.5, max = 1) # assumes fish is at or just 2x above SMR during daytime in deep water
  activity_factor_foraging.vec <- runif(nsims, min = 1, max = 4) # Assumes fish metabolizes at least at 2x SMR (if SMR is 1/2 RMR) and as high as 8x SMR during nighttime foraging
  activity_factor_migrating.vec <- runif(nsims, min = 1, max = 4) # Assumes fish metabolizes at least at 2x SMR (if SMR is 1/2 RMR) and as high as 8x SMR during during migration (relevant for VM fish only)
  time_resting.vec <- runif(nsims, min = .33, max = .66) # assumes migrating fish spend 50% of the time inactive (deep) in mesopelagic zone resting. Same for NM fish.
  
  G_VM.vec <- runif(nsims, min = 0.018-0.018*0.5, max = 0.018+0.018*0.5)
  # 0.0018 for VM fish, 0.0007 for NM fish
  
  theta.vec <- runif(nsims, min = 0.54, max = 1)

  # First, assume that oxygen consumption during respirometry experiments is due only to M, not also to SDA (food assimilation). Realistically some of the fish from Ikeda 2016 regression were probably still digesting food, so we will also consider a case where the measured O2 updated is due to both M and SDA combined (respiration rate, in units of energy usage, = M + SDA). 

  prop_SDA.vec <- runif(nsims, min = 0.14 * 0.8, max = 0.14 * 1.2) # Nominal value from Brett and Groves (they used 0.14), allowed to vary by 20%
  prop_egestion.vec <- runif(nsims, min = 0.20 * 0.8, max = 0.20 * 1.2) # Nominal value from Brett and Groves (0.20), allowed to vary by 20%
  prop_excretion.vec <- runif(nsims, min = 0.07 * 0.8, max = 0.07 * 1.2) # Nominal value from Brett and Groves (0.07), allowed to vary by 20%
  
  # for SDAe function
  timeTo90.vec <- runif(nsims, min = 10, max = 14)
  peakTime.vec <- runif(nsims, min = 3- 3*.8, max = 3+ 3*.8)
  
  Q_ox_kJ_g_O2.vec <- runif(nsims, min = 13.4- (13.4*0.1), max = 13.4 + (13.4*0.1)) # From Jobling 1994. Oxycalorific equivalent (energy obtained from respired oxygen) in units of kJ/gO2. Nelson et al. 2016 states that this may vary by 10% at most (sd of about 1).
  
  RQ.vec <- runif(nsims, min = 0.7, max = 2) # Hernandez-Leon et al. 2019 used respiratory quotient (CO2 respired/O2 consumed) of 0.97 (from Omori and Ikeda, 1984). Davison et al. 2013 and Ariza et al. 2015 used respiratory quotient of 0.90 (Brett and Groves 1979). Hudson let this range from 0.7-1.0, given uncertainty associated with mesopelagic fish. According to Brett and Groves 1979, RQ could = 2 for fish that undergo some amount of anaerobic metabolism.
  
  Dmax.vec <- runif(nsims, min = 300, max = 700)
  
  Dmin.vec <- runif(nsims, min = 10, max = 90)
  
  B.vec <- runif(nsims, min = 100, max = 200)
  
  S.vec <- runif(nsims, min = 5- (5*.3), max = 5+ (5*.3)) # see table 1 for refs for swimming speed. note that in the code we make swim speed in cm/s and then multiply by 0.01 (unit used in references), but in the equation (to remove the 0.01 unit conversion factor) we provide swim speed in m/s. 
  
  energy_in_pellet.vec <- runif(nsims, min = 0.6, max = 3.5)
  
  C_in_pellet.vec <- runif(nsims, min = 0.05, max = 0.10)
  
  proportion_egestion_below_150m.vec <- runif(nsims, min = 0.50, max = 0.90) # 50-90% sinks below 150m
  
  C_c_vm.vec <- runif(nsims, min = 0.038, max = 0.248) # Ratio of carbon:wet weight of VM fish, from mean of species captured 
# in this study, and Childress and Nygaard (1973). In Davison et al. 2013--they used 0.49 for carbon:wet weight ratio, but in Childress and Nygaard paper this was about 0.50 for carbon:DRY weight. Mesopelagic fish ranged from about 60% to 90% water, and carbon:ash free dry weight (assumed here to be the same as dry weight, because % ash is small) ranged from 38-62%. To find bounds: min carbon:wet weight = (1-0.90) * 0.38 = 0.038, and max carbon:wet weight = (1-0.60) * 0.62 = 0.248
  
    X_r.vec <- runif(nsims, min = 0.008 - 0.8*0.008, max = 0.008 + 0.8*0.008) # see Table 1--these values came from Wilson et al. 2009 and then were converted to mgC /d/ WMfish. Allow to vary by 80%
  
    X_e.vec <- runif(nsims, min = 0.5, max = 0.9)
      
    # For Pauly 1980 mortality regression, simply allow mu to vary by +/- 0.3
    # log_{10}(\mu) = a_0 + a_1 log_{10}(L_{\infty}) + a_2log_{10}(K) + a_3log_{10}(T_{mean}) 
    aa0 <- -0.0066
    aa1 <- -0.2790
    aa2 <- 0.6543
    aa3 <- 0.4634
    Linfinity <- 8.7 # average of the 3 myctophid Linfinity values in Pauly 1980
    K <- 0.2 # arbitrary value between 0.3 and 0.4 for VM fish (Pauly 1980) 
    # and 0.05 and 0.17 for NM fish (Childress et al 1980)
    # use same parameter values for NM fish for now due to limited data
    TT_mean_nominal_value <- 12.5 # set TT_mean
    mu.mean <- 10^ (aa0 + aa1*log10(Linfinity) + aa2*log10(K) + aa3*log10(TT_mean_nominal_value))
    mu.vec <- runif(nsims, min = mu.mean- mu.mean*.5, max = mu.mean+ mu.mean*.5) 
    prop_mortality_below_150m.vec <- runif(nsims, min = .40, max = .90)
    
    # with all parameter vectors created, now calculate C flux for each MC iteration in nsims
    for(i in 1:nsims) {
      C_flux_i <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[1] 
      output[i] = C_flux_i # units of mg
    }
    output.mat <- cbind(output, a0.vec, a1.vec, a2.vec, a3.vec, H_VM_or_NM.vec, TT_epipelagic.vec, TT_mesopelagic.vec, TT_mean.vec, activity_factor_resting.vec, activity_factor_foraging.vec, activity_factor_migrating.vec, time_resting.vec, Dmax.vec, Dmin.vec, B.vec, S.vec, prop_SDA.vec, prop_egestion.vec, prop_excretion.vec, G_VM.vec, theta.vec, peakTime.vec, timeTo90.vec, X_r.vec, X_e.vec, mu.vec, Q_ox_kJ_g_O2.vec, RQ.vec, energy_in_pellet.vec, C_in_pellet.vec, proportion_egestion_below_150m.vec, C_c_vm.vec, prop_mortality_below_150m.vec)
    colnames(output.mat) <- c("C_flux", "a0", "a1", "a2", "a3", "VM_NM", "T_epi", "T_meso", "T_mean", "A_r", "A_f", "A_m", "t_r", "Dmax", "Dmin", "B", "S", "prop_SDA", "prop_F","prop_X", "G_VM", "theta", "t_peak", "t_90", "X_r", "X_e", "mu", "Q_ox", "RQ", "E_p", "C_p", "F_e", "C_c", "M_e")
    
    # re-run but make new data frame that includes only the C_flux values by pathway (for boxplot later). Note that from C.flux.function, output is c(total, resp, SDA, egestion, excretion, mortality, ingestion). At the end of the C.flux.function call below, the [1], [2], etc selects which pathway to enter into each column
    pathways_output <- tibble(total_flux = rep(NA, nsims), resp_flux = rep(NA, nsims), SDA_flux = rep(NA, nsims), eg_flux = rep(NA, nsims), ex_flux = rep(NA, nsims), mort_flux = rep(NA, nsims))
    for (i in 1:nsims){
      
      # total C flux
      pathways_output[i,1] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[1]
      
      # respiratory C flux
      pathways_output[i,2] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[2]
      
      # SDA C flux
      pathways_output[i,3] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[3]
      
      # egestion flux
      pathways_output[i,4] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[4]
      
      # excretion flux
      pathways_output[i,5] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[5]
      
      # mortality flux
      pathways_output[i,6] <- C.flux.function.VM(W_w_f_VM=W_w_f_VM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_epipelagic=TT_epipelagic.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], activity_factor_migrating=activity_factor_migrating.vec[i], time_resting=time_resting.vec[i], Dmax=Dmax.vec[i], Dmin=Dmin.vec[i], B=B.vec[i], S=S.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_VM=G_VM.vec[i], theta=theta.vec[i], peakTime=peakTime.vec[i], timeTo90=timeTo90.vec[i], X_r=X_r.vec[i], X_e=X_e.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i],  proportion_egestion_below_150m=proportion_egestion_below_150m.vec[i], C_c_vm=C_c_vm.vec[i], prop_mortality_below_150m=prop_mortality_below_150m.vec[i])[6]
    }
    return(list(output.mat, pathways_output))
}

# carbon flux as total, per individual
run_MC_VM <- MC_func_VM(nsims=1000, W_w_f_VM = 1, Wref = 1000, Tref = 15)[[1]]# 1g fish, nsims = 1000

# carbon flux by carbon flux pathway
run_MC_pathways_VM <- MC_func_VM(nsims=1000, W_w_f_VM = 1, Wref = 1000, Tref = 15)[[2]]# 1g fish, nsims = 1000

```


```{r Monte Carlo function NM fish, echo = FALSE}

# Find NM fish C flux such that NM fish MC function output is generated using the same parameter values (where applicable) as for VM fish. For argument VM_output, input the name of the first object in the list generated in the MC_func_VM function (iin the MC_func_VM function, the first object that is returned in the list is the data frame of C flux values per iteration and parameter values selected for each of those iterations)

# Note: need to create the appropriate VM fish output and pass this to MC_func_NM each time MC_func_NM is used (e.g. if we want nsims=5000 for MC_func_NM, need to pass the MC_func_VM output that also uses nsims = 5000 so that the parameter vectors are the correct length)

# Monte Carlo function for NM fish. Always use same parameters as in VM fish function, where applicable (not all VM fish parameters appear in NM fish C flux function)

# Enter W_w_f in g and Wref in mg

MC_func_NM <- function(nsims, W_w_f_NM, Wref, Tref, output_VM){
  output_NM <- rep(NA, nsims)
  W_w_f_NM <- W_w_f_NM # set this in argument of MC_func_NM
  
  # generate parameter vector that are unique to VM fish (no equivalent for VM fish)
  G_NM.vec <- runif(nsims, min = 0.007-0.007*0.5, max = 0.007+0.007*0.5) 
  prop_non_detrital_NM_prey.vec <- runif(nsims, min = 0.7-0.7*.2, max = 0.7+0.7*.2) 
  H_VM_or_NM.vec <- runif(nsims, min = 0, max = 0) # use 1 for VM fish or 0 for NM fish function 

  # generate parameter vectors that are the same as those generated for MC_func_VM
  a0.vec <- output_VM$a0
  a1.vec <- output_VM$a1
  a2.vec <- output_VM$a2
  a3.vec <- output_VM$a3
  TT_mesopelagic.vec <- output_VM$T_meso
  TT_mean.vec <- output_VM$T_mean 
  activity_factor_resting.vec <- output_VM$A_r
  activity_factor_foraging.vec <-output_VM$A_f
  time_resting.vec <- output_VM$t_r
  theta.vec <- output_VM$theta
  prop_SDA.vec <- output_VM$prop_SDA
  prop_egestion.vec <- output_VM$prop_F
  prop_excretion.vec <- output_VM$prop_X
  Q_ox_kJ_g_O2.vec <- output_VM$Q_ox
  RQ.vec <- output_VM$RQ
  energy_in_pellet.vec <- output_VM$E_p
  C_in_pellet.vec <- output_VM$C_p
  C_c_nm.vec <- output_VM$C_c
  X_r.vec <- output_VM$X_r
  mu.vec <- output_VM$mu
  
  # with all parameter vectors created, now calculate C flux for each MC iteration in nsims
  for(i in 1:nsims) {
    C_flux_i <- C.flux.function.NM (W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[1] 
    output_NM[i] = C_flux_i # units of mg 
  }
  output_NM.mat <- cbind(output_NM, a0.vec, a1.vec, a2.vec, a3.vec, H_VM_or_NM.vec, TT_mesopelagic.vec, TT_mean.vec, activity_factor_resting.vec, activity_factor_foraging.vec, time_resting.vec, prop_SDA.vec, prop_egestion.vec, prop_excretion.vec, G_NM.vec, theta.vec, X_r.vec, mu.vec, Q_ox_kJ_g_O2.vec, RQ.vec, prop_non_detrital_NM_prey.vec, energy_in_pellet.vec, C_in_pellet.vec, C_c_nm.vec)
  colnames(output_NM.mat) <- c("C_flux", "a0", "a1", "a2", "a3", "VM_NM", "T_meso", "T_mean", "A_r", "A_f", "t_r", "prop_SDA", "prop_F","prop_X", "G_NM", "theta", "X_r", "mu", "Q_ox", "RQ", "Z", "E_p", "C_p", "C_c")
  
    # re-run but make new data frame that includes only the C_flux values by pathway (for boxplot later). Note that from C.flux.function, output is c(total, resp, SDA, egestion, excretion, mortality, ingestion). At the end of the C.flux.function call below, the [1], [2], etc selects which pathway to enter into each column
    pathways_output_NM <- tibble(total_flux = rep(NA, nsims), resp_flux = rep(NA, nsims), SDA_flux = rep(NA, nsims), eg_flux = rep(NA, nsims), ex_flux = rep(NA, nsims), mort_flux = rep(NA, nsims))
    for (i in 1:nsims){
      
      # total C flux
      pathways_output_NM[i,1] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[1]
      
      # respiratory C flux
      pathways_output_NM[i,2] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[2] 
      
      # SDA C flux
      pathways_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[3]
      
      # egestion flux
      pathways_output_NM[i,4] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[4] 
      
      # excretion flux
      pathways_output_NM[i,5] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[5]
      
      # mortality flux
      pathways_output_NM[i,6] <- C.flux.function.NM(W_w_f_NM=W_w_f_NM, Wref=Wref, Tref=Tref, a0=a0.vec[i], a1=a1.vec[i], a2=a2.vec[i], a3=a3.vec[i], H_VM_or_NM=H_VM_or_NM.vec[i], TT_mesopelagic=TT_mesopelagic.vec[i], TT_mean=TT_mean.vec[i],  activity_factor_resting=activity_factor_resting.vec[i], activity_factor_foraging=activity_factor_foraging.vec[i], time_resting=time_resting.vec[i], prop_SDA=prop_SDA.vec[i], prop_egestion=prop_egestion.vec[i], prop_excretion=prop_excretion.vec[i], G_NM=G_NM.vec[i], theta=theta.vec[i], X_r=X_r.vec[i], mu = mu.vec[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2.vec[i], RQ=RQ.vec[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey.vec[i], energy_in_pellet=energy_in_pellet.vec[i], C_in_pellet=C_in_pellet.vec[i], C_c_nm=C_c_nm.vec[i])[6]
    }
    return(list(output_NM.mat, pathways_output_NM))
}


# VM fish C flux and parameter values from MC_func_VM, for passing to the MC_func_NM function
MC_VM_data_frame <- as.data.frame(run_MC_VM)

# carbon flux as total, per individual
run_MC_NM <- MC_func_NM(nsims=1000, W_w_f_NM = 1, Wref = 1000, Tref = 15, output_VM = MC_VM_data_frame)[[1]] # 1g fish

# make into data frame
MC_NM_data_frame <- as.data.frame(run_MC_NM)

# carbon flux by pathway
run_MC_pathways_NM <- MC_func_NM(nsims=1000, W_w_f_NM = 1, Wref = 1000, Tref = 15, output_VM = MC_VM_data_frame)[[2]] # 1g fish



# find the difference between VM and NM fish C fluxes (to confirm that, for at least inner 95% range of Monte Carlo literations, VM fish C flux is greater than NM fish C flux)

# compare VM and NM fish Monte Carlo estimates (same parameter values were used where possible, due to how the MC_func_NM function was coded above)

# put VM and NM fish results into data frame 
VM_NM_C_flux_same_pars <- data.frame(C_flux_VM = MC_VM_data_frame$C_flux, C_flux_NM = MC_NM_data_frame$C_flux)

# add column for difference between VM and NM fish C flux
VM_NM_C_flux_same_pars <- cbind(VM_NM_C_flux_same_pars, diff = VM_NM_C_flux_same_pars$C_flux_VM - VM_NM_C_flux_same_pars$C_flux_NM)

# remove the extremes, find 95% range 
range_95_same_pars <- signif(quantile(VM_NM_C_flux_same_pars$diff, probs=c(.025,.975)))

# plot histogram with VM and NM fish data overlapping in a single plot
hist_diff_VM_NM <- ggplot(data = VM_NM_C_flux_same_pars, aes(x = diff)) + geom_histogram() + theme_bw() + theme(legend.title=element_blank(), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18)) + xlab(bquote("\n Difference in carbon flux (grams carbon per individual per day)")) + ylab(bquote("Frequency from Monte Carlo simulations (n=1000) \n"))

# without keeping parameters the same where possible for both VM and NM fish, there are more iterations where VM fish transport less than NM fish (and it makes more sense to compare apples to apples for each iteration to keep shared parameters consistent between the two iterations compared). Without filtering to 95% range, there are about 15 of 1000 iterations where the NM fish flux is higher than the VM fish flux, but as with other results we'll look at the 95% range of these calculated differences. 

# range of differences on an annual basis, to include in results:
range_95_same_pars*365

```


```{r table of outputs, echo = FALSE}

# calculate absolute min max (but report 95% range, because absolute min and max will vary 
# with each set of MC simulations). 95% range did not vary over multiple MC simulations. 

# calculate empirical 95% range (no normality assumption)
# for VM and NM fish
min_95 <- c(signif(quantile(run_MC_VM[,1], probs=c(.025,.975))[1],3), signif(quantile(run_MC_NM[,1], probs=c(.025,.975))[1],3))
max_95 <- c(signif(quantile(run_MC_VM[,1], probs=c(.025,.975))[2],3), signif(quantile(run_MC_NM[,1], probs=c(.025,.975))[2],3))

# calculate empirical 99% range (no normality assumption)
# for VM and NM fish
min_99 <- c(signif(quantile(run_MC_VM[,1], probs=c(.01,.99))[1],3), signif(quantile(run_MC_NM[,1], probs=c(.01,.99))[1]),3)
max_99 <- c(signif(quantile(run_MC_VM[,1], probs=c(.01,.99))[2],3), signif(quantile(run_MC_NM[,1], probs=c(.01,.99))[2],3))

# calculate median and mean values for VM and NM fish (can edit code below to switch between 
# 95 and 99% range)
med_data <- c(signif(median(run_MC_VM[,1]),3), signif(median(run_MC_NM[,1]),3))
mean_data <- c(signif(mean(run_MC_VM[,1]),3), signif(mean(run_MC_NM[,1]),3))

outputs <- cbind(min_95, max_95, med_data, mean_data)
rownames(outputs) <- c("Vertically migrating", "Non-migrating")
colnames(outputs) <- c("Min (95%)", "Max (95%)", "Median", "Mean")

kable(outputs, caption = "Summary statistics (95% range) of fish-mediated carbon flux results from the Monte Carlo simulation for a 1 g fish (in units of milligrams of carbon per individual per day).", escape = FALSE)

# to calculate annual rates as % of body mass (for 1 g fish): 
annual_percent_bodymass_1g_min <- min_95 * 365 * 100 # values shown are for VM and NM fish
annual_percent_bodymass_1g_max <- max_95 * 365 * 100 # values shown are for VM and NM fish


# to find annual rates instead: 
outputs * 365

```


```{r C flux function for VM fish to find intermediate C flux pathway contributions, echo = FALSE}

## VM fish flux function
# use C.flux.function.VM, described previously, but give nominal parameter values and use intermediate C flux outputs for respiratory, egestion and mortality fluxes. This function returns c(C_vm_tot, C_r_VM, C_SDA_VM, C_f_VM, C_x_VM, C_mu_VM, I_VM)

# nominal values for each parameter
W_w_f_VM <- 1
Wref <- 1000
Tref <- 15
a0 <- as.numeric(coefficients(resp_model_center)[1])
a1 <- as.numeric(coefficients(resp_model_center)[2])
a2 <- as.numeric(coefficients(resp_model_center)[3])
a3  <- as.numeric(coefficients(resp_model_center)[4])
H_VM  <- 1 # ** change to 0 for NM fish
TT_epipelagic  <- 14
TT_mesopelagic  <- 11
TT_mean  <- 12.5
activity_factor_resting  <- .75
activity_factor_migrating  <- 2.5
activity_factor_foraging  <- 2.5
time_resting  <- 0.5
Dmax  <- 500
Dmin  <- 50
B <- 150
S <- 11
prop_SDA  <- 0.14
prop_egestion  <- 0.20
prop_excretion  <- 0.07
G_VM <- 0.018
theta <- 0.77
peakTime <- 3
timeTo90 <- 12
mu <- 0.606
Q_ox_kJ_g_O2  <- 13.4 
RQ  <- 1.35
energy_in_pellet  <- 2 
C_in_pellet <- 0.075 
proportion_egestion_below_150m <- 0.7
C_c_vm <- 0.1
prop_mortality_below_150m <- 0.65
X_r <- 0.008
X_e <- 0.7


C_flux_pathways_VM <- C.flux.function.VM (W_w_f_VM, Wref, Tref, a0=a0, a1=a1 , a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, activity_factor_migrating=activity_factor_migrating, time_resting=time_resting, Dmax=Dmax, Dmin=Dmin, B=B, S=S, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_VM=G_VM, theta=theta, peakTime=peakTime, timeTo90=timeTo90, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, X_r=X_r, X_e=X_e, mu=mu, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m) # output is c(total, resp, SDA, egestion, excretion, mortality, ingestion

# make vector of nominal values (used later for plotting standardization by +/- % of nominal values)
nominal_vals_VM <- c(W_w_f_VM, Wref, Tref, a0, a1, a2, a3, H_VM, TT_epipelagic, TT_mesopelagic, TT_mean, activity_factor_resting, activity_factor_foraging, activity_factor_migrating, time_resting, Dmax, Dmin, B, S, prop_SDA, prop_egestion, prop_excretion, G_VM, theta, peakTime, timeTo90, X_r, X_e, mu, Q_ox_kJ_g_O2, RQ, energy_in_pellet, C_in_pellet, proportion_egestion_below_150m, C_c_vm, prop_mortality_below_150m)

# make vector of nominal values (could use this later for plotting standardization by +/- % of nominal values)
nominal_vals_VM_names <- as.character(quote(c(W_w_f_VM, Wref, Tref, a0, a1, a2, a3, H_VM, TT_epipelagic, TT_mesopelagic, TT_mean, activity_factor_resting, activity_factor_foraging, activity_factor_migrating, time_resting, Dmax, Dmin, B, S, prop_SDA, prop_egestion, prop_excretion, G_VM, theta, peakTime, timeTo90, X_r, X_e, mu, Q_ox_kJ_g_O2, RQ, energy_in_pellet, C_in_pellet, proportion_egestion_below_150m, C_c_vm, prop_mortality_below_150m)))[-1]


```

```{r C flux function for NM fish to find intermediate C flux pathway contributions, echo = FALSE}

## NM fish flux function
# use C.flux.function.NM, described previously, but give nominal parameter values and use intermediate C flux outputs for respiratory, egestion and mortality fluxes. This function returns c(C_nm_tot, C_r_NM, C_f_NM, C_m_NM, I_NM)

# nominal values for each NM parameter (left out parameters that were already defined earlier in VM fish code)
W_w_f_NM <- 1
H_NM  <- 0 # ** changed to 0 for NM fish
G_NM <- 0.007
C_c_nm <- 0.1 
prop_non_detrital_NM_prey <- 0.7

C_flux_pathways_NM <- C.flux.function.NM(W_w_f_NM, Wref, Tref, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, X_r=X_r, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm) # output is c(total, resp, SDA, egestion, excretion, mortality, ingestion)

# make vector of nominal values (could use this later for plotting standardization by +/- % of nominal values)
nominal_vals_NM_names <- as.character(quote(c(W_w_f_NM, Wref, Tref, a0, a1, a2, a3, H_NM, TT_mesopelagic, activity_factor_resting, activity_factor_foraging, time_resting, prop_SDA, prop_egestion, prop_excretion, G_NM, theta, X_r, mu, Q_ox_kJ_g_O2, RQ, prop_non_detrital_NM_prey, energy_in_pellet, C_in_pellet, C_c_nm)))[-1]

```

### Daily ingestion rate (for comparing with QB method)
```{r find daily ingestion rate}

# find ingestion rate (in g/d) for purposes of comparing with Q/B values in the literature
# note than in ouptut, the first 4 values are in units of mgC/d, and the final value is in kJ/d (so, daily ingested energy)
C_flux_pathways_NM[7] 


```


```{r table of outputs by flux pathway, echo = FALSE}

resp_flux <- c(signif(C_flux_pathways_VM[2]/C_flux_pathways_VM[1]*100,3), signif(C_flux_pathways_NM[2]/C_flux_pathways_NM[1]*100,3) )

SDA_flux <- c(signif(C_flux_pathways_VM[3]/C_flux_pathways_VM[1]*100,3), signif(C_flux_pathways_NM[3]/C_flux_pathways_NM[1]*100,3) )

eg_flux <- c(signif(C_flux_pathways_VM[4]/C_flux_pathways_VM[1]*100,3), signif(C_flux_pathways_NM[4]/C_flux_pathways_NM[1]*100,3) )  

ex_flux <- c(signif(C_flux_pathways_VM[5]/C_flux_pathways_VM[1]*100,3), signif(C_flux_pathways_NM[5]/C_flux_pathways_NM[1]*100,3) )  

mort_flux <- c(signif(C_flux_pathways_VM[6]/C_flux_pathways_VM[1]*100,3), signif(C_flux_pathways_NM[6]/C_flux_pathways_NM[1]*100,3) )

outputs <- cbind(resp_flux, SDA_flux, eg_flux, ex_flux, mort_flux)
rownames(outputs) <- c("Vertically migrating", "Non-migrating")
colnames(outputs) <- c("Respiration (%)", "SDA (%)", "Egestion (%)", "Excretion (%)","Mortality (%)")

kable(outputs, caption = "Summary of fish-mediated carbon flux results, based on nominal parameter values, by type of carbon release pathway. Pathways of carbon release include respiration of carbon dioxide from metabolism (locomotion and maintenance), respiration from specific dynamic action (food digestion), egestion of particulate organic carbon, excretion of inorganic particulate carbon (carbonates), or mortality via predation below the flux boundary. Values are shown as percentages of total carbon transported by each type of fish (vertically migrating or non-migrating) based on nominal values of each parameter.", escape = FALSE)

```

## Individual parameter perturbation

```{r run VM individual parameter perturbation, echo = FALSE}

## Individual parameter perturbation simulation for VM fish carbon flux

# min, max, nominal, and range for each parameter

# standard errors from respiration rate equation
std_errors <- summary(resp_model_center)$coefficients[, 2]

# allow respiration rate coefficients to vary +/- 2 SE
a0_min <- a0 - 2*as.numeric(std_errors[1])
a0_max <- a0 + 2*as.numeric(std_errors[1])
a0_range <- c(a0_min, a0_max)

a1_min <- a1 - 2*as.numeric(std_errors[2])
a1_max <- a1 + 2*as.numeric(std_errors[2])
a1_range <- c(a1_min, a1_max)

a2_min = a2 - 2*as.numeric(std_errors[3])
a2_max = a2 + 2*as.numeric(std_errors[3])
a2_range <- c(a2_min, a2_max)

a3_min <- a3 - 2*as.numeric(std_errors[4])
a3_max <- a3 + 2*as.numeric(std_errors[4])
a3_range <- c(a3_min, a3_max)

H_VM  <- 1 # ** change to 0 for NM fish
H_VM_min <- 1
H_VM_max <- 1
H_VM_range <- c(H_VM_min, H_VM_max)
  
TT_epipelagic_min <- TT_epipelagic-5
TT_epipelagic_max <- TT_epipelagic+5
TT_epipelagic_range <- c(TT_epipelagic_min, TT_epipelagic_max)

TT_mesopelagic_min <- TT_mesopelagic-5
TT_mesopelagic_max <- TT_mesopelagic+5
TT_mesopelagic_range <- c(TT_mesopelagic_min, TT_mesopelagic_max)

TT_mean_min <- TT_mean-5
TT_mean_max <- TT_mean+5
TT_mean_range <- c(TT_mean_min, TT_mean_max)

activity_factor_resting_min <- 0.5
activity_factor_resting_max <- 1
activity_factor_resting_range <- c(activity_factor_resting_min, activity_factor_resting_max)

activity_factor_migrating  <- 2.5
activity_factor_migrating_min <- 1
activity_factor_migrating_max <- 4
activity_factor_migrating_range <- c(activity_factor_migrating_min, activity_factor_migrating_max)

activity_factor_foraging  <- 2.5
activity_factor_foraging_min <- 1
activity_factor_foraging_max <- 4
activity_factor_foraging_range <- c(activity_factor_foraging_min, activity_factor_foraging_max)

time_resting_min <- 0.33 # equivalent of 8 hrs
time_resting_max <- 0.66 # equivalent of 16 hrs
time_resting_range <- c(time_resting_min, time_resting_max)

G_VM_min <-  G_VM * 0.5
G_VM_max <- G_VM * 1.5
G_VM_range <- c(G_VM_min, G_VM_max)

prop_SDA_min <- prop_SDA * 0.8
prop_SDA_max <- prop_SDA * 1.2
prop_SDA_range <- c(prop_SDA_min, prop_SDA_max)

prop_egestion_min <- prop_egestion * 0.8
prop_egestion_max <- prop_egestion * 1.2
prop_egestion_range <- c(prop_egestion_min, prop_egestion_max)

prop_excretion_min  <- prop_excretion * 0.8
prop_excretion_max  <- prop_excretion * 1.2
prop_excretion_range  <- c(prop_excretion_min, prop_excretion_max)

theta_min <- 0.54
theta_max <- 1
theta_range <- c(theta_min, theta_max)

peakTime_min <- 3- 3*.8
peakTime_max <- 3+ 3*.8
peakTime_range <- c(peakTime_min, peakTime_max)

timeTo90_min <- 10
timeTo90_max <- 14
timeTo90_range <- c(timeTo90_min,timeTo90_max)

proportion_egestion_below_150m_min <- 0.5
proportion_egestion_below_150m_max <- 0.9
proportion_egestion_below_150m_range <- c(proportion_egestion_below_150m_min, proportion_egestion_below_150m_max)

X_r_min <- X_r * 0.2
X_r_max <- X_r * 1.8
X_r_range <- c(X_r_min, X_r_max)

X_e_min <- 0.5
X_e_max <- 0.9
X_e_range <- c(X_e_min, X_e_max)

mu_min <- mu - mu*.5
mu_max <- mu + mu*.5
mu_range <- c(mu_min, mu_max)

Q_ox_kJ_g_O2_min  <- 13.4 * 0.9
Q_ox_kJ_g_O2_max  <- 13.4 * 1.1
Q_ox_kJ_g_O2_range  <- c(Q_ox_kJ_g_O2_min, Q_ox_kJ_g_O2_max)

RQ_min  <- .7
RQ_max  <- 2
RQ_range  <- c(RQ_min, RQ_max)

Dmax_min  <- 300
Dmax_max  <- 700
Dmax_range  <- c(Dmax_min, Dmax_max)

Dmin_min  <- 10
Dmin_max  <- 90
Dmin_range  <- c(Dmin_min, Dmin_max)

B_min  <- 100
B_max  <- 200
B_range  <- c(B_min, B_max)

S_min  <- 3
S_max  <- 20
S_range  <- c(S_min, S_max)

energy_in_pellet  <- 2 
energy_in_pellet_min  <- 0.6 
energy_in_pellet_max  <- 3.5
energy_in_pellet_range  <- c(energy_in_pellet_min, energy_in_pellet_max)

C_in_pellet_min <- 0.05
C_in_pellet_max <- 0.1
C_in_pellet_range <- c(C_in_pellet_min, C_in_pellet_max)

C_c_vm <- 0.143 # in paper, we call this mg C / g fish wet mass, but in the code we just multiply by 1000 and keep this is mg C / mg fish wet mass
C_c_vm_min <- 0.038
C_c_vm_max <- 0.248
C_c_vm_range <- c(C_c_vm_min, C_c_vm_max)

prop_mortality_below_150m_min <- .40
prop_mortality_below_150m_max <- .90
prop_mortality_below_150m_range <- c(prop_mortality_below_150m_min, prop_mortality_below_150m_max)

# set parameter ranges for plots
a0_vector <- seq(from = a0_range[1], to =  a0_range[2], 
                 length.out = 1000)

a1_vector <- seq(from = a1_range[1], to =  a1_range[2], 
                 length.out = 1000)

a2_vector <- seq(from = a2_range[1], to =  a2_range[2], 
                 length.out = 1000)

a3_vector <- seq(from = a3_range[1], to =  a3_range[2], 
                 length.out = 1000)

H_VM_vector <- seq(from =  H_VM_range[1], to =   H_VM_range[2], length.out = 1000)

TT_epipelagic_vector <- seq(from = TT_epipelagic_range[1], to =  TT_epipelagic_range[2], length.out = 1000)

TT_mesopelagic_vector <- seq(from = TT_mesopelagic_range[1], to =  TT_mesopelagic_range[2], length.out = 1000)
  
TT_mean_vector <- seq(from = TT_mean_range[1], to =  TT_mean_range[2], length.out = 1000)

activity_factor_resting_vector <- seq(from = activity_factor_resting_range[1], to =  activity_factor_resting_range[2], length.out = 1000)
  
activity_factor_migrating_vector <- seq(from = activity_factor_migrating_range[1],  to =  activity_factor_migrating_range[2], length.out = 1000)
  
activity_factor_foraging_vector <- seq(from = activity_factor_foraging_range[1], to =  activity_factor_foraging_range[2], length.out = 1000)
  
time_resting_vector <- seq(from = time_resting_range[1], 
                                      to =  time_resting_range[2],
                                      length.out = 1000)

G_VM_vector <- seq(from = G_VM_range[1], to = G_VM_range[2], length.out = 1000)

timeTo90_vector <- seq(from = timeTo90_range[1], to = timeTo90_range[2], length.out = 1000)

peakTime_vector <- seq(from = peakTime_range[1], to = peakTime_range[2], length.out = 1000)

prop_SDA_vector <- seq(from = prop_SDA_range[1], to =  prop_SDA_range[2], length.out = 1000)
  
prop_egestion_vector <- seq(from = prop_egestion_range[1], 
                            to =  prop_egestion_range[2], 
                            length.out = 1000)

prop_excretion_vector <- seq(from = prop_excretion_range[1], to =  prop_excretion_range[2], length.out = 1000)

theta_vector <- seq(from = theta_range[1], to = theta_range[2], length.out = 1000)

X_r_vector <- seq(from = X_r_range[1], to = X_r_range[2], length.out = 1000)

X_e_vector <- seq(from = X_e_range[1], to = X_e_range[2], length.out = 1000)

mu_vector <- seq(from = mu_range[1], to = mu_range[2], length.out = 1000)

Q_ox_kJ_g_O2_vector <- seq(from = Q_ox_kJ_g_O2_range[1], to =  Q_ox_kJ_g_O2_range[2], length.out = 1000)

RQ_vector <- seq(from = RQ_range[1], to =  RQ_range[2], 
                 length.out = 1000)

Dmax_vector <- seq(from = Dmax_range[1], to =  Dmax_range[2], 
                 length.out = 1000)

Dmin_vector <- seq(from = Dmin_range[1], to =  Dmin_range[2], 
                 length.out = 1000)

B_vector <- seq(from = B_range[1], to =  B_range[2], 
                 length.out = 1000)

S_vector <- seq(from = S_range[1], to =  S_range[2], 
                 length.out = 1000)


energy_in_pellet_vector <- seq(from = energy_in_pellet_range[1], to = energy_in_pellet_range[2], length.out = 1000)

energy_in_pellet_vector <- seq(from = energy_in_pellet_range[1], to =  energy_in_pellet_range[2], length.out = 1000)

C_in_pellet_vector <- seq(from = C_in_pellet_range[1], to =  C_in_pellet_range[2], length.out = 1000)

proportion_egestion_below_150m_vector <- seq(from = proportion_egestion_below_150m_range[1], to =  proportion_egestion_below_150m_range[2], 
                 length.out = 1000)

C_c_vm_vector <- seq(from = C_c_vm_range[1], to =  C_c_vm_range[2], 
                 length.out = 1000)

prop_mortality_below_150m_vector <- seq(from = prop_mortality_below_150m_range[1], to =  prop_mortality_below_150m_range[2], 
                 length.out = 1000)

a0_output <- data.frame(par_name = "a0", par_value = a0_vector, C_flux = NA)
for (i in 1:length(a0_vector)) {
  a0_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0_vector[i], a1=a1, a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] # units in mg. The [1] specifies to use only the first element in the output of C.flux.function.VM
}

a1_output <- data.frame(par_name = "a1", par_value = a1_vector, C_flux = NA)
for (i in 1:length(a1_vector)) {
  a1_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1_vector[i], a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

a2_output <- data.frame(par_name = "a2", par_value = a2_vector, C_flux = NA)
for (i in 1:length(a2_vector)) {
  a2_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2_vector[i], a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

a3_output <- data.frame(par_name = "a3", par_value = a3_vector, C_flux = NA)
for (i in 1:length(a3_vector)) {
  a3_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3_vector[i], H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

TT_epipelagic_output <- data.frame(par_name = "TT_epipelagic", par_value = TT_epipelagic_vector, C_flux = NA)
for (i in 1:length(TT_epipelagic_vector)) {
  TT_epipelagic_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic_vector[i], TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

TT_mesopelagic_output <- data.frame(par_name = "TT_mesopelagic", par_value = TT_mesopelagic_vector, C_flux = NA)
for (i in 1:length(TT_mesopelagic_vector)) {
  TT_mesopelagic_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic_vector[i], TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

TT_mean_output <- data.frame(par_name = "TT_mean", par_value = TT_mean_vector, C_flux = NA)
for (i in 1:length(TT_mean_vector)) {
  TT_mean_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean_vector[i],  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

activity_factor_resting_output <- data.frame(par_name = "activity_factor_resting", par_value = activity_factor_resting_vector, C_flux = NA)
for (i in 1:length(activity_factor_resting_vector)) {
  activity_factor_resting_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting_vector[i], activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

activity_factor_migrating_output <- data.frame(par_name = "activity_factor_migrating", par_value = activity_factor_migrating_vector, C_flux = NA)
for (i in 1:length(activity_factor_migrating_vector)) {
  activity_factor_migrating_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating_vector[i], activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

activity_factor_foraging_output <- data.frame(par_name = "activity_factor_foraging", par_value = activity_factor_foraging_vector, C_flux = NA)
for (i in 1:length(activity_factor_foraging_vector)) {
  activity_factor_foraging_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging_vector[i], time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

time_resting_output <- data.frame(par_name = "time_resting", par_value = time_resting_vector, C_flux = NA)
for (i in 1:length(time_resting_vector)) {
  time_resting_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting_vector[i], G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

G_VM_output <- data.frame(par_name = "G_VM", par_value = G_VM_vector, C_flux = NA)
for (i in 1:length(G_VM_vector)) { 
  G_VM_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM_vector[i], prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_SDA_output <- data.frame(par_name = "prop_SDA", par_value = prop_SDA_vector, C_flux = NA)
for (i in 1:length(prop_SDA_vector)) {
  prop_SDA_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA_vector[i], prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_egestion_output <- data.frame(par_name = "prop_egestion", par_value = prop_egestion_vector, C_flux = NA)
for (i in 1:length(prop_egestion_vector)) {
  prop_egestion_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion_vector[i], prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_excretion_output <- data.frame(par_name = "prop_excretion", par_value = prop_excretion_vector, C_flux = NA)
for (i in 1:length(prop_excretion_vector)) {
  prop_excretion_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion_vector[i], theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

theta_output <- data.frame(par_name = "theta", par_value = theta_vector, C_flux = NA)
for (i in 1:length(theta_vector)) {
  theta_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta_vector[i], peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}


# Note: the optim() function occasionally comes up with a value that falls lower or higher than the line where the vast majority of points fall on, so we removed points with a C flux < 0.00230 and above 0.00260.

peakTime_output_unfiltered <- data.frame(par_name = "peakTime", par_value = peakTime_vector, C_flux = NA)
for (i in 1:length(peakTime_vector)) {
  peakTime_output_unfiltered[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime_vector[i], timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

# filter out values that are too high or too low
peakTime_output_fewer_rows <- peakTime_output_unfiltered %>% filter(C_flux<2.6 & C_flux>2.4)

# create this number of additional rows to add to nrows = nsims
number_rows_to_add <- nsims - length(peakTime_output_fewer_rows$C_flux)

# create random list of values that will correspond to the row numbers selected to duplicate
rows_to_add <- sample(x = 1:number_rows_to_add, size = number_rows_to_add, replace = FALSE)

# create new data frame with additional rows adding up to nsims
peakTime_output <- rbind(peakTime_output_fewer_rows, peakTime_output_fewer_rows[rows_to_add,])

timeTo90_output <- data.frame(par_name = "timeTo90", par_value = timeTo90_vector, C_flux = NA)
for (i in 1:length(timeTo90_vector)) {
  timeTo90_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90_vector[i], X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

X_r_output <- data.frame(par_name = "X_r", par_value = X_r_vector, C_flux = NA)
for (i in 1:length(X_r_vector)) {
  X_r_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r_vector[i], X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

X_e_output <- data.frame(par_name = "X_e", par_value = X_e_vector, C_flux = NA)
for (i in 1:length(X_e_vector)) {
  X_e_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e_vector[i], mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

mu_output <- data.frame(par_name = "mu", par_value = mu_vector, C_flux = NA)
for (i in 1:length(mu_vector)) {
  mu_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu_vector[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Q_ox_kJ_g_O2_output <- data.frame(par_name = "Q_ox_kJ_g_O2", par_value = Q_ox_kJ_g_O2_vector, C_flux = NA)
for (i in 1:length(Q_ox_kJ_g_O2_vector)) {
  Q_ox_kJ_g_O2_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2_vector[i], RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

RQ_output <- data.frame(par_name = "RQ", par_value = RQ_vector, C_flux = NA)
for (i in 1:length(RQ_vector)) {
  RQ_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ_vector[i], Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Dmax_output <- data.frame(par_name = "Dmax", par_value = Dmax_vector, C_flux = NA)
for (i in 1:length(Dmax_vector)) {
  Dmax_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax_vector[i], Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Dmin_output <- data.frame(par_name = "Dmin", par_value = Dmin_vector, C_flux = NA)
for (i in 1:length(Dmin_vector)) {
  Dmin_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin_vector[i], B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

B_output <- data.frame(par_name = "B", par_value = B_vector, C_flux = NA)
for (i in 1:length(B_vector)) {
  B_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B_vector[i], S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

S_output <- data.frame(par_name = "S", par_value = S_vector, C_flux = NA)
for (i in 1:length(S_vector)) {
  S_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S_vector[i], energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

energy_in_pellet_output <- data.frame(par_name = "energy_in_pellet", par_value = energy_in_pellet_vector, C_flux = NA)
for (i in 1:length(energy_in_pellet_vector)) {
  energy_in_pellet_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet_vector[i], C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

C_in_pellet_output <- data.frame(par_name = "C_in_pellet", par_value = C_in_pellet_vector, C_flux = NA)
for (i in 1:length(C_in_pellet_vector)) {
  C_in_pellet_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet_vector[i],  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

proportion_egestion_below_150m_output <- data.frame(par_name = "proportion_egestion_below_150m", par_value = proportion_egestion_below_150m_vector, C_flux = NA)
for (i in 1:length(proportion_egestion_below_150m_vector)) {
  proportion_egestion_below_150m_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m_vector[i], C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

C_c_vm_output <- data.frame(par_name = "C_c_vm", par_value = C_c_vm_vector, C_flux = NA)
for (i in 1:length(C_c_vm_vector)) {
  C_c_vm_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm_vector[i], prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_mortality_below_150m_output <- data.frame(par_name = "prop_mortality_below_150m", par_value = prop_mortality_below_150m_vector, C_flux = NA)
for (i in 1:length(prop_mortality_below_150m_vector)) {
  prop_mortality_below_150m_output[i,3] <- C.flux.function.VM(W_w_f_VM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m_vector[i])[1] 
}

# create data frame with all VM fish IPP data
IPP_df_VM <- rbind(a0_output, a1_output, a2_output, a3_output, TT_epipelagic_output, TT_mesopelagic_output, TT_mean_output, activity_factor_foraging_output, activity_factor_migrating_output, activity_factor_resting_output, time_resting_output, G_VM_output, prop_SDA_output, prop_egestion_output, prop_excretion_output, theta_output, peakTime_output, timeTo90_output, X_r_output, X_e_output, mu_output, Q_ox_kJ_g_O2_output, RQ_output, Dmax_output, Dmin_output, B_output, S_output, energy_in_pellet_output, C_in_pellet_output, proportion_egestion_below_150m_output, C_c_vm_output, prop_mortality_below_150m_output)


```



```{r plot VM individual parameter perturbation, echo = FALSE, fig.width=7, fig.height=5, fig.cap = "Individual parameter perturbation plots for a 1 g VM fish, showing the full range of each parameter value on the x-axis and carbon flux in units of grams of carbon per individual per day on the y-axis. A greater slope indicates higher sensitivity of the output to that parameter."}

# create labels for multiplot
# make labels for multiplot
my_labeller_IPP_VM <- as_labeller(c(activity_factor_foraging="A[f]", activity_factor_migrating="A[m]", activity_factor_resting="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", a3="alpha[3]", B="B", C_c_vm="C[c]", C_in_pellet="C[p]", Dmax="D[max]", Dmin="D[min]", energy_in_pellet="e[p]", proportion_egestion_below_150m="E[F]", G_VM="G[VM]", prop_mortality_below_150m ="E[mu]", mu="mu", prop_egestion="phi[F]", prop_SDA="phi[SDA]", prop_excretion="phi[X]", Q_ox_kJ_g_O2 ="Q[ox]", RQ="R[Q]", S="S", timeTo90="t[90]", TT_epipelagic="T[epi]", TT_mean="T[mean]", TT_mesopelagic="T[meso]", peakTime="t[peak]", time_resting="t[r]", theta="theta", X_e="E[X]", X_r="X[r]"),
                           default = label_parsed)

# make data frame of all parameter and C flux values
IPP_VM <- rbind(a0_output, a1_output, a2_output, a3_output, TT_epipelagic_output, TT_mesopelagic_output, TT_mean_output, activity_factor_resting_output, activity_factor_foraging_output, activity_factor_migrating_output, time_resting_output, Dmax_output, Dmin_output, B_output, S_output, prop_SDA_output, prop_egestion_output, prop_excretion_output, G_VM_output, theta_output, peakTime_output, timeTo90_output, X_r_output, X_e_output, mu_output, Q_ox_kJ_g_O2_output, RQ_output, energy_in_pellet_output, C_in_pellet_output, proportion_egestion_below_150m_output, C_c_vm_output, prop_mortality_below_150m_output)

# re-order factors for plotting in same order as parameters appear in equations in text
IPP_VM$par_name <- factor(IPP_VM$par_name, levels = c("a0", "a1", "a2", "a3", "TT_epipelagic", "TT_mesopelagic", "TT_mean", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_migrating", "activity_factor_resting", "time_resting", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM", "prop_SDA", "peakTime", "timeTo90", "prop_egestion", "energy_in_pellet", "C_in_pellet", "proportion_egestion_below_150m", "prop_excretion", "X_r", "X_e", "C_c_vm", "mu", "prop_mortality_below_150m"))

# create parameter groups
resp_flux_IPP <- c("a0", "a1", "a2", "a3", "TT_epipelagic", "TT_mesopelagic", "TT_mean", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_migrating", "activity_factor_resting", "time_resting", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM")
SDA_flux_IPP <- c("prop_SDA", "peakTime", "timeTo90")
eg_flux_IPP <- c("prop_egestion", "energy_in_pellet", "C_in_pellet", "proportion_egestion_below_150m")
ex_flux_IPP <- c("prop_excretion", "X_r", "X_e")
mort_flux_IPP <- c("C_c_vm", "mu", "prop_mortality_below_150m")

# add column for color coding, by parameter group
IPP_VM$group <- rep(NA, length(IPP_VM$par_name))
IPP_VM <- IPP_VM %>%
  mutate(group = factor(case_when(par_name %in% resp_flux_IPP ~ "respiratory flux and growth", par_name %in% SDA_flux_IPP ~ "specific dynamic action flux", par_name %in% eg_flux_IPP ~ "egestion flux", par_name %in% ex_flux_IPP ~ "excretion flux", par_name %in% mort_flux_IPP ~ "mortality flux", TRUE ~ NA_character_)))

# re-order levels for legend 
IPP_VM$group <- factor(IPP_VM$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux"))

# get axis tick marks to work with new package ggh4x with additional options for faceted plots
position_scales_VM <- list(scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="a0")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="a0")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="a1")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="a1")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="a2")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="a2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="a3")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="a3")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="TT_epipelagic")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="TT_epipelagic")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="TT_mesopelagic")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="TT_mesopelagic")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="TT_mean")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="TT_mean")])),2)),
                        scale_x_continuous(breaks = c(12.3, 15.0)), # hard coded in... this code wasn't working: signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_foraging")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_foraging")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_migrating")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_migrating")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_resting")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="activity_factor_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="time_resting")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="time_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="theta")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="theta")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="Dmax")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="Dmax")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="Dmin")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="Dmin")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="B")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="B")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="S")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="S")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="RQ")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="RQ")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="G_VM")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="G_VM")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="prop_SDA")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="prop_SDA")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="peakTime")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="peakTime")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="timeTo90")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="timeTo90")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="prop_egestion")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="prop_egestion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="energy_in_pellet")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="energy_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="C_in_pellet")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="C_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="proportion_egestion_below_150m")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="proportion_egestion_below_150m")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="prop_excretion")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="prop_excretion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="X_r")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="X_r")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="X_e")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="X_e")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="C_c_vm")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="C_c_vm")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="mu")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="mu")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM$par_value[which(IPP_VM$par_name=="prop_mortality_below_150m")]), max(IPP_VM$par_value[which(IPP_VM$par_name=="prop_mortality_below_150m")])),2)))

# plot IPP results for VM fish
plot_IPP_VM <- ggplot(data = IPP_VM, aes(x = par_value, y = C_flux)) + scale_y_continuous(breaks = c(0, 4), limits = c(0.0, 4.5)) +
  geom_line(data = IPP_VM, aes(x = par_value, y = C_flux, color = group), alpha = 3, linewidth = 1) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top",  strip.background.x = element_blank(), legend.text = element_text(size = 14), strip.text.x = element_text(size = 18), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18), panel.spacing = unit(2.5, 'lines'), plot.margin = unit(c(1, 1, 1, 1), units = "line")) +
  facet_wrap(vars(par_name), ncol = 8, scales = "free_x", labeller = my_labeller_IPP_VM) +
  xlab(bquote("\n Parameter values for vertically migrating fish (units vary)")) + ylab(bquote("Carbon flux (mg carbon per individual per day) \n")) + facetted_pos_scales(x = position_scales_VM) + scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A")) + guides(color = guide_legend(nrow=2,byrow=TRUE))

# used colors from Color Brewer "Dark2" palette for figures (viridis package)

# plot VM IPP results
plot_IPP_VM
 

# make data frame to find % change in C flux from min to max of each par value range
IPP_VM_sensitivity <- IPP_VM %>%
  group_by(par_name) %>%
  summarise(
    min_C_flux_by_par = min(C_flux),
    max_C_flux_by_par = max(C_flux)
  ) %>%
  arrange(par_name)

# delete extra column at bottom with NA
IPP_VM_sensitivity <- IPP_VM_sensitivity[1:32,]

IPP_VM_sensitivity$percent_change_C <- rep(NA, times = length(IPP_VM_sensitivity$min_C_flux_by_par))
IPP_VM_sensitivity$percent_change_C <- round((IPP_VM_sensitivity$max_C_flux_by_par - IPP_VM_sensitivity$min_C_flux_by_par) / IPP_VM_sensitivity$min_C_flux_by_par * 100, 1)

# round other columns to 3 sig figs 
IPP_VM_sensitivity$min_C_flux_by_par <- signif(IPP_VM_sensitivity$min_C_flux_by_par, 3) 
IPP_VM_sensitivity$max_C_flux_by_par <- signif(IPP_VM_sensitivity$max_C_flux_by_par, 3) 

# coerce from tibble to data frame to allow column and row name editing
IPP_VM_sensitivity_table <- as.data.frame(IPP_VM_sensitivity)

par_names_VM <- c(
  "$\\alpha_0$",
  "$\\alpha_1$",
  "$\\alpha_2$",
  "$\\alpha_3$",
  "$T_{epi}$",
  "$T_{meso}$",
  "$T_{mean}$",
  "$Q_{ox}$",
  "$A_{f}$",
  "$A_{m}$",
  "$A_{r}$",
  "$t_{r}$",
  "$\\theta$",
  "$D_{max}$",
  "$D_{min}$",
  "$S$",
  "$B$",
  "$RQ$",
  "$G_{VM}$",
  "$\\phi_{SDA}$",
  "$t_{peak}$",
  "$t_{90}$",
  "$\\phi_{F}$",
  "$e_{p}$",
  "$C_{p}$",
  "$E_{F}$",  
  "$\\phi_{X}$",
  "$X_{r}$", 
  "$E_{X}$", 
  "$C_{c}$",
  "$\\mu$",
  "$E_{\\mu}$"
)

IPP_VM_sensitivity_table$par_name <- rep(NA, times = length(IPP_VM_sensitivity_table$min_C_flux_by_par))
  
IPP_VM_sensitivity_table$par_name <- par_names_VM

IPP_VM_sensitivity_table <- IPP_VM_sensitivity_table %>% arrange(desc(percent_change_C))

colnames(IPP_VM_sensitivity_table) <- c("Parameter name", "Minimum C flux", "Maximum C flux", "Percent change in C flux")


# export as CSV file (or can knit this document to word) 
# write.csv(IPP_VM_sensitivity_table, "IPP_VM_sensitivity_table.csv", row.names = F)

kable(IPP_VM_sensitivity_table, caption = "Percent change in vertically migrating fish carbon flux (mg C per individual per day) from the minimum to the maximum parameter value, based on individual parameter perturbation calculations. Minimum and maximum parameter values are based on the literature and, where knowledge gaps remain, educated guesses of feasible parameter ranges.", escape = FALSE) 
# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("IPP_VM_plot.jpg", plot = plot_IPP_VM, device = "jpeg", width = 170*2, height = 112*2, units = c("mm"), dpi = 500)
# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("IPP_VM_plot.jpg", plot = plot_IPP_VM, device = "jpeg", width = 170*2, height = 112*2, units = c("mm"), dpi = 500)

```


```{r troubleshoot weird peakTime result, include = FALSE}
peakTime_df <- cbind(as.vector(peakTime_vector), as.vector(peakTime_output$C_flux))
colnames(peakTime_df) <- c("peakTime", "Cflux")
which(peakTime_df[,2]<= 2.6) # these peakTime values (in the list from 1 to 1000) are causing especially LOW C flux values

which(peakTime_df[,2]>= 2.9) # these peakTime values (in the list from 1 to 1000) are causing especially HIGH C flux values

# The function optim() is not always choosing the best parameter value. Could use the previous estimate in the next estimate, with each iteration, so that starting value is closer to what the final estimate would be. Or just truncate results to exclude the very high or very low estimates, which are only an artifact of how optim does the optimization. This has now been fixed in the function above--keeping this troubleshooting code in to flag that the min/max cut offs for peakTime_output may need to be adjusted if other parts of code are edited in the future that would affect the desired min/max cutoffs for this parameter vector in the IPP. 
```


```{r run NM individual parameter perturbation, include = FALSE}

## Individual parameter perturbation simulation for NM fish carbon flux

# To avoid duplicate parameter value assignment, parameters that are already assigned 
# a value above for VM fish are excluded here. 

# min, max, nominal, and range for each parameter

H_NM  <- 0 # ** changed to 0 for NM fish
H_NM_min <- 0
H_NM_max <- 0
H_NM_range <- c(H_NM_min, H_NM_max)

G_NM <- 0.007
G_NM_min <-  G_NM * 0.5
G_NM_max <- G_NM * 1.5
G_NM_range <- c(G_NM_min, G_NM_max)

prop_non_detrital_NM_prey  <- 0.7
prop_non_detrital_NM_prey_min  <- 0.7 * 0.8
prop_non_detrital_NM_prey_max   <- 0.7 * 1.2
prop_non_detrital_NM_prey_range  <- c(prop_non_detrital_NM_prey_min, prop_non_detrital_NM_prey_max)

C_c_nm <- 0.143 # same as for VM fish due to lack of data
C_c_nm_min <- 0.038
C_c_nm_max <- 0.248
C_c_nm_range <- c(C_c_nm_min, C_c_nm_max)

# set parameter ranges for plots (some ranges are already assigned in VM fish code above)

G_NM_vector <- seq(from = G_NM_range[1], to =  G_NM_range[2],
                                      length.out = 1000)

prop_non_detrital_NM_prey_vector <- seq(from = prop_non_detrital_NM_prey_range[1], to =  prop_non_detrital_NM_prey_range[2], length.out = 1000)

C_c_nm_vector <- seq(from = C_c_nm_range[1], to =  C_c_nm_range[2], 
                 length.out = 1000)

a0_output_NM <- data.frame(par_name = "a0", par_value = a0_vector, C_flux = NA)
for (i in 1:length(a0_vector)) {
  a0_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0_vector[i], a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] # units of mg. The [1] specifies to use only the first element in the output of C.flux.function.NM
}

a1_output_NM <- data.frame(par_name = "a1", par_value = a1_vector, C_flux = NA)
for (i in 1:length(a1_vector)) {
  a1_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1_vector[i], a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

a2_output_NM <- data.frame(par_name = "a2", par_value = a2_vector, C_flux = NA)
for (i in 1:length(a2_vector)) {
  a2_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2_vector[i], a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

a3_output_NM <- data.frame(par_name = "a3", par_value = a3_vector, C_flux = NA)
for (i in 1:length(a3_vector)) {
  a3_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3_vector[i], H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

TT_mesopelagic_output_NM <- data.frame(par_name = "TT_mesopelagic", par_value = TT_mesopelagic_vector, C_flux = NA)
for (i in 1:length(TT_mesopelagic_vector)) {
  TT_mesopelagic_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic_vector[i], activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

activity_factor_resting_output_NM <- data.frame(par_name = "activity_factor_resting", par_value = activity_factor_resting_vector, C_flux = NA)
for (i in 1:length(activity_factor_resting_vector)) {
  activity_factor_resting_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting_vector[i], activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

activity_factor_foraging_output_NM <- data.frame(par_name = "activity_factor_foraging", par_value = activity_factor_foraging_vector, C_flux = NA)
for (i in 1:length(activity_factor_foraging_vector)) {
  activity_factor_foraging_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging_vector[i], time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

time_resting_output_NM <- data.frame(par_name = "time_resting", par_value = time_resting_vector, C_flux = NA)
for (i in 1:length(time_resting_vector)) {
  time_resting_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting_vector[i], prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

prop_SDA_output_NM <- data.frame(par_name = "prop_SDA", par_value = prop_SDA_vector, C_flux = NA)
for (i in 1:length(prop_SDA_vector)) {
  prop_SDA_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA_vector[i], prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

prop_egestion_output_NM <- data.frame(par_name = "prop_egestion", par_value = prop_egestion_vector, C_flux = NA)
for (i in 1:length(prop_egestion_vector)) {
  prop_egestion_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion_vector[i], prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

prop_excretion_output_NM <- data.frame(par_name = "prop_excretion", par_value = prop_excretion_vector, C_flux = NA)
for (i in 1:length(prop_excretion_vector)) {
  prop_excretion_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion_vector[i], G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

G_NM_output_NM <- data.frame(par_name = "G_NM", par_value = G_NM_vector, C_flux = NA)
for (i in 1:length(G_NM_vector)) {
  G_NM_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM_vector[i], theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

theta_output_NM <- data.frame(par_name = "theta", par_value = theta_vector, C_flux = NA)
for (i in 1:length(theta_vector)) {
  theta_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta_vector[i], mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

mu_output_NM <- data.frame(par_name = "mu", par_value = mu_vector, C_flux = NA)
for (i in 1:length(mu_vector)) {
  mu_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu_vector[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

prop_non_detrital_NM_prey_output_NM <- data.frame(par_name = "Z", par_value = prop_non_detrital_NM_prey_vector, C_flux = NA)
for (i in 1:length(prop_non_detrital_NM_prey_vector)) {
  prop_non_detrital_NM_prey_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey_vector[i], X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

X_r_output_NM <- data.frame(par_name = "X_r", par_value = X_r_vector, C_flux = NA)
for (i in 1:length(X_r_vector)) {
  X_r_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r_vector[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

Q_ox_kJ_g_O2_output_NM <- data.frame(par_name = "Q_ox_kJ_g_O2", par_value = Q_ox_kJ_g_O2_vector, C_flux = NA)
for (i in 1:length(Q_ox_kJ_g_O2_vector)) {
  Q_ox_kJ_g_O2_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2_vector[i], RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

RQ_output_NM <- data.frame(par_name = "RQ", par_value = RQ_vector, C_flux = NA)
for (i in 1:length(RQ_vector)) {
  RQ_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ_vector[i], energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

energy_in_pellet_output_NM <- data.frame(par_name = "energy_in_pellet", par_value = energy_in_pellet_vector, C_flux = NA)
for (i in 1:length(energy_in_pellet_vector)) {
  energy_in_pellet_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet_vector[i], C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1]
}

C_in_pellet_output_NM <- data.frame(par_name = "C_in_pellet", par_value = C_in_pellet_vector, C_flux = NA)
for (i in 1:length(C_in_pellet_vector)) {
  C_in_pellet_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet_vector[i], C_c_nm=C_c_nm)[1]
}

C_c_nm_output_NM <- data.frame(par_name = "C_c_nm", par_value = C_c_nm_vector, C_flux = NA)
for (i in 1:length(C_c_nm_vector)) {
  C_c_nm_output_NM[i,3] <- C.flux.function.NM(W_w_f_NM=1, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm_vector[i])[1]
}

```


```{r plot NM individual parameter perturbation, echo = FALSE, fig.width=7, fig.height=5, fig.cap = "Individual parameter perturbation plots for a 1 g NM fish, showing the full range of each parameter value on the x-axis and carbon flux in units of grams of carbon per individual per day on the y-axis. A greater slope indicates higher sensitivity of the output to that parameter. The x-axis units corresponding to each parameter can be found using Table 1."}

# make data frame of all parameter and C flux values (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
IPP_NM <- rbind(a0_output_NM, a1_output_NM, a2_output_NM, TT_mesopelagic_output_NM, activity_factor_resting_output_NM, activity_factor_foraging_output_NM, time_resting_output_NM, prop_SDA_output_NM, prop_egestion_output_NM, prop_excretion_output_NM, G_NM_output_NM, theta_output_NM, X_r_output_NM, mu_output_NM, prop_non_detrital_NM_prey_output_NM, Q_ox_kJ_g_O2_output_NM, RQ_output_NM, energy_in_pellet_output_NM, C_in_pellet_output_NM, C_c_nm_output_NM)

# re-order factors for plotting in same order as parameters appear in equations in text (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
IPP_NM$par_name <- factor(IPP_NM$par_name, levels = c("a0", "a1", "a2", "TT_mesopelagic", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_resting", "time_resting", "theta", "RQ", "G_NM", "prop_SDA", "prop_egestion", "energy_in_pellet", "C_in_pellet", "prop_excretion", "X_r", "C_c_nm", "mu", "Z"))

# create parameter groups (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
resp_flux_IPP <- c("a0", "a1", "a2", "TT_mesopelagic", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_resting", "time_resting", "theta", "RQ", "G_NM")
SDA_flux <- c("prop_SDA")
eg_flux_IPP <- c("prop_egestion", "energy_in_pellet", "C_in_pellet")
ex_flux_IPP <- c("prop_excretion", "X_r")
mort_flux_IPP <- c("C_c_nm", "mu")
all_fluxes <- "Z"

# add column for color coding, by parameter group
IPP_NM <- IPP_NM %>%
  mutate(group = factor(case_when(par_name %in% resp_flux_IPP ~ "respiratory flux and growth", par_name %in% SDA_flux ~ "specific dynamic action flux", par_name %in% eg_flux_IPP ~ "egestion flux", par_name %in% ex_flux_IPP ~ "excretion flux", par_name %in% mort_flux_IPP ~ "mortality flux", par_name %in% all_fluxes ~ "ratio of non-detrital prey",  TRUE ~ NA_character_)))

# re-order levels for legend 
IPP_NM$group <- factor(IPP_NM$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux", "ratio of non-detrital prey"))

# create labels for each parameter's plot
my_labeller_IPP_NM <- as_labeller(c(activity_factor_foraging="A[f]", activity_factor_resting="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", B="B", C_c_nm="C[c]", C_in_pellet="C[p]", energy_in_pellet="e[p]", G_NM="G[NM]", mu="mu", prop_egestion="phi[F]", prop_SDA="phi[SDA]", prop_excretion="phi[X]", Q_ox_kJ_g_O2="Q[ox]", RQ="R[Q]", S="S", TT_mesopelagic="T[meso]", time_resting="t[r]", theta="theta", X_r="X[r]", Z="Z"), default = label_parsed)

# get axis tick marks to work with new package ggh4x with additional options for faceted plots
position_scales_NM <- list(scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="a0")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="a0")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="a1")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="a1")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="a2")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="a2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="TT_mesopelagic")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="TT_mesopelagic")])),2)),
                        scale_x_continuous(breaks = c(12.3, 15.0)), # hard coded in... this code wasn't working: signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="activity_factor_foraging")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="activity_factor_foraging")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="activity_factor_resting")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="activity_factor_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="time_resting")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="time_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="theta")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="theta")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="RQ")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="RQ")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="G_NM")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="G_NM")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="prop_SDA")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="prop_SDA")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="prop_egestion")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="prop_egestion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="energy_in_pellet")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="energy_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="C_in_pellet")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="C_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="prop_excretion")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="prop_excretion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="X_r")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="X_r")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="C_c_nm")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="C_c_nm")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="mu")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="mu")])),2)),                                            scale_x_continuous(breaks = signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="Z")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="Z")])),2)))

# plot IPP results for NM fish
plot_IPP_NM <- ggplot(data = IPP_NM, aes(x = par_value, y = C_flux)) + scale_y_continuous(breaks = c(0, 4), limits = c(0, 4.5)) + geom_line(data = IPP_NM, aes(x = par_value, y = C_flux, color = group), alpha = 3, linewidth = 1) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), legend.text = element_text(size = 14), strip.text.x = element_text(size = 18), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18), panel.spacing = unit(2.5, 'lines'), plot.margin = unit(c(1, 1, 1, 1), units = "line")) +
  facet_wrap(vars(par_name), ncol = 8, scales = "free_x", labeller = my_labeller_IPP_NM) +
  xlab(bquote("\n Parameter values for non-migrating fish (units vary)")) + ylab(bquote("Carbon flux (mg carbon per individual per day) \n")) + facetted_pos_scales(x = position_scales_NM) + scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A",  "#1B9E77")) + guides(color = guide_legend(nrow=2,byrow=TRUE))

# used colors from Color Brewer "Dark2" palette for figures (viridis package)

# print plot
plot_IPP_NM

# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("IPP_NM_plot.jpg", plot = plot_IPP_NM, device = "jpeg", width = 170*2, height = 103*2, units = c("mm"), dpi = 500)

# make data frame to find % change in C flux from min to max of each par value range
IPP_NM_sensitivity <- IPP_NM %>%
  group_by(par_name) %>%
  summarise(
    min_C_flux_by_par = min(C_flux),
    max_C_flux_by_par = max(C_flux)
  ) %>%
  arrange(par_name)

IPP_NM_sensitivity$percent_change_C <- round((IPP_NM_sensitivity$max_C_flux_by_par - IPP_NM_sensitivity$min_C_flux_by_par) / IPP_NM_sensitivity$min_C_flux_by_par * 100, 1)

# round other columns to 3 sig figs 
IPP_NM_sensitivity$min_C_flux_by_par <- signif(IPP_NM_sensitivity$min_C_flux_by_par, 3) 
IPP_NM_sensitivity$max_C_flux_by_par <- signif(IPP_NM_sensitivity$max_C_flux_by_par, 3) 

# coerce from tibble to data frame to allow column and row name editing
IPP_NM_sensitivity_table <- as.data.frame(IPP_NM_sensitivity)

par_names_NM <- c(
  "$\\alpha_0$",
  "$\\alpha_1$",
  "$\\alpha_2$",
  "$T_{meso}$",
  "$Q_{ox}$",
  "$A_{f}$",
  "$A_{r}$",
  "$t_{r}$",
  "$\\theta$",
  "$RQ$",
  "$G_{NM}$",
  "$\\phi_{SDA}$",
  "$\\phi_{F}$",
  "$e_{p}$",
  "$C_{p}$",
  "$\\phi_{X}$",
  "$X_{r}$", 
  "$C_{c}$",
  "$\\mu$",
  "$Z$"
  )

IPP_NM_sensitivity_table$par_name <- par_names_NM

IPP_NM_sensitivity_table <- IPP_NM_sensitivity_table %>% arrange(desc(percent_change_C))

colnames(IPP_NM_sensitivity_table) <- c("Parameter name", "Minimum C flux", "Maximum C flux", "Percent change in C flux")

kable(IPP_NM_sensitivity_table, caption = "Percent change in non-migrating fish carbon flux (mg C per individual per day) from the minimum to the maximum parameter value, based on individual parameter perturbation calculations. Minimum and maximum parameter values are based on the literature and, where knowledge gaps remain, educated guesses of feasible parameter ranges.", escape = FALSE) 

```


```{r plot VM and NM fish MC results with 5000 sims, echo = FALSE}
# carbon flux as total, per individual
run_MC_VM_5000 <- MC_func_VM(nsims=5000, W_w_f_VM = 1, Wref = 1000, Tref = 15)[[1]]# 1g fish, nsims = 5000

# make into data frame
run_MC_VM_5000_df <- as.data.frame(run_MC_VM_5000)

# pass that VM fish output data frame to the NM fish MC function
run_MC_NM_5000 <- MC_func_NM(nsims=5000, W_w_f_NM = 1, Wref = 1000, Tref = 15, output_VM = run_MC_VM_5000_df)[[1]] # 1g fish, nsims = 5000


### VM fish ###

# make output a data frame
run_MC_VM_df_5000 <- as.data.frame(run_MC_VM_5000) # nsims = 5000

# plot with standardized x axis (Z score) and find quantile GAM lines

# write get_upper_lower function to make length.out = 5000, k = 8, and shade inner 80% percentile later
get_lower_upper_5000 <- function(x, y, k = 8, err = 0.10, lowerbd, upperbd, medianbd) {
  dat <- tibble(x = x, y = y)
  predict.df = tibble(x = seq(min(x), max(x), length.out = 5000),
                y = 0
  )
  fit.lower <- qgam(y~s(x, k=k, bs="ad"), data = dat, qu = lowerbd)
  pred.lower <- predict(fit.lower, newdata = predict.df)
  fit.upper <- qgam(y~s(x, k=k, bs="ad"), data = dat, qu = upperbd)
  pred.upper <- predict(fit.upper, newdata = predict.df)
  fit.median <- qgam(y~s(x, k=k, bs="ad"), data = dat, qu = medianbd)
  pred.median <- predict(fit.median, newdata = predict.df)
  
  return(cbind(x = predict.df$x, lower = pred.lower, upper = pred.upper, median = pred.median))
}

# re-write function that generates quantile GAM data frames that includes get_lower_upper_5000 function for nsims = 5000
# create generic code so we can repeat this later for all parameters
quantiles_df_func_5000 <- function(df_all_pars, single_par){
  one_par_df <- filter(df_all_pars, par_name== single_par)
  qgam_df <- as.data.frame(get_lower_upper_5000(x=one_par_df$par_value, y=one_par_df$C_flux,
                                           k=8, err = 0.10, lowerbd=0.10, upperbd=0.90, medianbd=0.50))
  quantile_df_5000 <- data.frame(one_par_df, median = qgam_df$median, lower = qgam_df$lower, upper = qgam_df$upper, x = qgam_df$x)
}

# plot with standardized x axis (Z score)
run_MC_VM_df_stand_5000 <- run_MC_VM_df_5000
number_variables_VM <- length(run_MC_VM_df_stand_5000[1,])
run_MC_VM_df_stand_5000[,2:number_variables_VM] <- scale(run_MC_VM_df_5000[,2:number_variables_VM])

# VM_NM habitat column is NaN because sd is zero and can't divide by zero. That's 
# fine before we're not going to plot this binary (0 or 1) categorical variable anyway. 
# convert wide to long format 
run_MC_VM_df_stand_long_5000 <- 
  run_MC_VM_df_stand_5000 %>%
  pivot_longer(cols = a0:M_e, names_to = "par_name", values_to = "par_value")

# filter out parameters we do not want to plot
run_MC_VM_df_stand_long_5000 <- filter(run_MC_VM_df_stand_long_5000, par_name != "VM_NM")

# re-order factors for plotting in same order as parameters appear in equations in text
run_MC_VM_df_stand_long_ordered_5000 <- run_MC_VM_df_stand_long_5000

run_MC_VM_df_stand_long_ordered_5000$par_name <- factor(run_MC_VM_df_stand_long_ordered_5000$par_name, levels = c("a0", "a1", "a2", "a3", "T_epi", "T_meso", "T_mean", "Q_ox", "A_f", "A_m", "A_r", "t_r", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM", "prop_SDA", "t_peak", "t_90", "prop_F", "E_p", "C_p", "F_e", "prop_X", "X_r", "X_e", "C_c", "mu", "M_e"))

# create parameter groups
resp_flux <- c("a0", "a1", "a2", "a3", "T_epi", "T_meso", "T_mean", "Q_ox", "A_f", "A_m", "A_r", "t_r", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM")
SDA_flux <- c("prop_SDA", "t_peak", "t_90")
eg_flux <- c("prop_F", "E_p", "C_p", "F_e")
ex_flux <- c("prop_X", "X_r", "X_e")
mort_flux <- c("C_c", "mu", "M_e")

# add column for color coding, by parameter group
MC_VM_data_5000 <- run_MC_VM_df_stand_long_ordered_5000 %>%
  mutate(group = factor(case_when(par_name %in% resp_flux ~ "respiratory flux and growth", par_name %in% SDA_flux ~ "specific dynamic action flux", par_name %in% eg_flux ~ "egestion flux", par_name %in% ex_flux ~ "excretion flux", par_name %in% mort_flux ~ "mortality flux", TRUE ~ NA_character_)))

# re-order for plotting
MC_VM_data_5000$group <- factor(MC_VM_data_5000$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux"))

# When I set k = 10, err = 0.15, IQR = 80%, start = 10:45pm and not sure when ended but done by ___
A_f_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "A_f")
A_m_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "A_m")
A_r_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "A_r")
a0_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "a0")
a1_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "a1")
a2_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "a2")
a3_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "a3")
T_epi_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "T_epi")
T_meso_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "T_meso")
T_mean_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "T_mean")
t_r_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "t_r")
Dmax_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "Dmax")
Dmin_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "Dmin")
B_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "B")
S_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "S")
prop_SDA_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "prop_SDA")
prop_F_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "prop_F")
prop_X_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "prop_X")
G_VM_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "G_VM")
theta_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "theta")
t_peak_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "t_peak")
t_90_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "t_90")
X_r_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "X_r")
X_e_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "X_e")
mu_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "mu")
Q_ox_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "Q_ox")
RQ_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "RQ")
E_p_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "E_p")
C_p_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "C_p")
F_e_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "F_e")
C_c_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "C_c")
M_e_df <- quantiles_df_func_5000(df_all_pars = MC_VM_data_5000, single_par = "M_e")

# rbind into one data frame
all_pars_df_VM_5000 <- rbind(A_f_df, A_m_df, A_r_df, a0_df, a1_df, a2_df, a3_df, T_epi_df, T_meso_df, T_mean_df, t_r_df, Dmax_df, Dmin_df, B_df, S_df, prop_SDA_df, prop_F_df, prop_X_df, G_VM_df, theta_df, t_peak_df, t_90_df, X_r_df, X_e_df, mu_df, Q_ox_df, RQ_df, E_p_df, C_p_df, F_e_df, C_c_df, M_e_df)

# make labels for multiplot
my_labeller <- as_labeller(c(A_f="A[f]", A_m="A[m]", A_r="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", a3="alpha[3]", B="B", C_c="C[c]", C_p="C[p]", Dmax="D[max]", Dmin="D[min]", E_p="e[p]", F_e="E[F]", G_VM="G[VM]", M_e="E[mu]", mu="mu", prop_F="phi[F]", prop_SDA="phi[SDA]", prop_X="phi[X]", Q_ox="Q[ox]", RQ="R[Q]", S="S", t_90="t[90]", T_epi="T[epi]", T_mean="T[mean]", T_meso="T[meso]", t_peak="t[peak]", t_r="t[r]", theta="theta", X_e="E[X]", X_r="X[r]"),
                           default = label_parsed)

# reduce tick marks by setting them to a given min and max C flux on y axis, and by setting Z score min and max on x axis to -2 and +2. See scale_y_continuous and scale_x_continuous arguments below

# create multiplot
plot_MC_VM_qgam_5000 <- ggplot(data = all_pars_df_VM_5000, aes(x = par_value, y = C_flux)) + scale_x_continuous(breaks = c(-2, 0, 2), limits = c(-2, 2)) + scale_y_continuous(breaks = c(0, 8), limits = c(0, 8)) + 
  geom_point(alpha = 0.02, size = .5) + 
  geom_line(data = all_pars_df_VM_5000, aes(x = x, y = lower), alpha = 0.5) + 
  geom_line(data = all_pars_df_VM_5000, aes(x = x, y = upper), alpha = 0.5) + 
  geom_line(data = all_pars_df_VM_5000, aes(x = x, y = median), alpha = 0.5) + 
  geom_ribbon(data = all_pars_df_VM_5000, aes(ymin=lower, ymax=upper, x=x, color = group, group = group,  fill = group), show.legend=TRUE, alpha = 0.2, lwd=0.5) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), strip.text.x = element_text(size = 20), panel.spacing = unit(1, 'lines'), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 20)) + 
  facet_wrap(vars(par_name), ncol = 8, labeller = my_labeller) + 
  xlab(bquote("\n Parameter values for vertically migrating fish (z-score)")) + 
  ylab(bquote("Carbon flux (mg carbon per individual per day) \n")) +
  scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A")) +
  scale_fill_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A")) +
  guides(color = guide_legend(nrow=2,byrow=TRUE))

# plot
plot_MC_VM_qgam_5000

# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("MC_VM_plot.jpg", plot = plot_MC_VM_qgam_5000, device = "jpeg", width = 170*2, height = 112*2, units = c("mm"), dpi = 500)


### NM fish ###

# make output a data frame
run_MC_NM_df_5000 <- as.data.frame(run_MC_NM_5000) # nsims = 5000

# Copy both VM and NM fish MC results to CSV files to store in repo: 
# write.csv(run_MC_VM_df_5000, "MC results for VM fish.csv")
# write.csv(run_MC_NM_df_5000, "MC results for NM fish.csv")

# standardize each column of parameter values by converting them to Z scores 
# no need to standardize C flux values in first column
run_MC_NM_df_stand_5000 <- run_MC_NM_df_5000
number_variables_NM <- length(run_MC_NM_df_stand_5000[1,])
run_MC_NM_df_stand_5000[,2:number_variables_NM] <- scale(run_MC_NM_df_5000[,2:number_variables_NM])

# VM_NM habitat column is NaN because sd is zero and can't divide by zero, which is
# fine because we're not going to plot this binary (0 or 1) categorical variable anyway.

# convert wide to long format 
run_MC_NM_df_stand_long_5000 <- 
  run_MC_NM_df_stand_5000 %>%
  pivot_longer(cols = a0:C_c, names_to = "par_name", values_to = "par_value")

# filter out parameters we do not want to plot
run_MC_NM_df_stand_long_5000 <- filter(run_MC_NM_df_stand_long_5000, par_name != "VM_NM")
# filter out the binary habitat depth variable. Could consider filtering out Tmean too for NM fish. 

# use same get_lower_upper and quantiles_df_func functions as above for VM fish

# re-order factors for plotting in same order as parameters appear in equations in text
run_MC_NM_df_stand_long_ordered_5000 <- run_MC_NM_df_stand_long_5000
run_MC_NM_df_stand_long_ordered_5000$par_name <- factor(run_MC_NM_df_stand_long_ordered_5000$par_name, levels = c("a0", "a1", "a2", "a3", "T_meso", "T_mean", "Q_ox", "A_f", "A_r", "t_r", "theta", "RQ", "G_NM", "prop_SDA", "prop_F", "E_p", "C_p", "prop_X", "X_r", "C_c", "mu", "Z"))

# create parameter groups
resp_flux <- c("a0", "a1", "a2", "a3", "T_meso", "T_mean", "Q_ox", "A_f", "A_r", "t_r", "theta", "RQ", "G_NM")
SDA_flux <- "prop_SDA"
eg_flux <- c("prop_F", "E_p", "C_p")
ex_flux <- c("prop_X", "X_r")
mort_flux <- c("C_c", "mu")
all_fluxes <- c("Z")

# add column for color coding, by parameter group
MC_NM_data_5000 <- run_MC_NM_df_stand_long_ordered_5000 %>%
  mutate(group = factor(case_when(par_name %in% resp_flux ~ "respiratory flux and growth", par_name %in% SDA_flux ~ "specific dynamic action flux", par_name %in% eg_flux ~ "egestion flux", par_name %in% ex_flux ~ "excretion flux", par_name %in% mort_flux ~ "mortality flux", par_name %in% all_fluxes ~ "ratio of non-detrital prey",  TRUE ~ NA_character_)))

# re-order for plot
MC_NM_data_5000$group <- factor(MC_NM_data_5000$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux", "ratio of non-detrital prey"))

# calculate quantiles for each parameter. started at 3:40, ended (k=10, nsims=1000, err=0.1, IQR = 80%)
A_f_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "A_f")
A_r_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "A_r")
a0_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "a0")
a1_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "a1")
a2_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "a2")
a3_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "a3")
T_meso_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "T_meso")
T_mean_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "T_mean")
t_r_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "t_r")
prop_SDA_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "prop_SDA")
prop_F_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "prop_F")
prop_X_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "prop_X")
Z_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "Z")
G_NM_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "G_NM")
theta_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "theta")
X_r_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "X_r")
mu_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "mu")
Q_ox_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "Q_ox")
RQ_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "RQ")
E_p_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "E_p")
C_p_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "C_p")
C_c_df_NM <- quantiles_df_func_5000(df_all_pars = MC_NM_data_5000, single_par = "C_c")

# rbind into one data frame
all_pars_df_NM <- rbind(A_f_df_NM, A_r_df_NM, a0_df_NM, a1_df_NM, a2_df_NM, a3_df_NM, T_meso_df_NM, T_mean_df_NM, t_r_df_NM, prop_SDA_df_NM, prop_F_df_NM, prop_X_df_NM, G_NM_df_NM, theta_df_NM, X_r_df_NM, mu_df_NM, Q_ox_df_NM, RQ_df_NM, E_p_df_NM, C_p_df_NM, C_c_df_NM, Z_df_NM)

# make labels for multiplot
my_labeller_NM <- as_labeller(c(A_f="A[f]", A_r="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", a3="alpha[3]", C_c="C[c]", C_p="C[p]", E_p="e[p]", G_NM="G[VM]", mu="mu", prop_F="phi[F]", prop_SDA="phi[SDA]", prop_X="phi[X]", Q_ox="Q[ox]", RQ="R[Q]", S="S", t_90="t[90]", T_mean="T[mean]", T_meso="T[meso]", t_r="t[r]", theta="theta", X_r="X[r]", Z="Z"), default = label_parsed)


# create multiplot 
plot_MC_NM_qgam_5000 <- ggplot(data = all_pars_df_NM, aes(x = par_value, y = C_flux)) + scale_y_continuous(breaks = c(0, 4), limits = c(0, 4)) + scale_x_continuous(breaks = c(-2, 0, 2), limits = c(-2.2, 2.2)) +
  geom_point(alpha = 0.02, size = .5) + 
  geom_line(data = all_pars_df_NM, aes(x = x, y = lower), alpha = 0.5) + 
  geom_line(data = all_pars_df_NM, aes(x = x, y = upper), alpha = 0.5) + 
  geom_line(data = all_pars_df_NM, aes(x = x, y = median), alpha = 0.5) + 
  geom_ribbon(data = all_pars_df_NM, aes(ymin=lower, ymax=upper, x=x, color = group, group = group,  fill = group), show.legend=TRUE, alpha = 0.2, lwd=0.5) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), strip.text.x = element_text(size = 20), panel.spacing = unit(1, 'lines'), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 20)) + 
  facet_wrap(vars(par_name), ncol = 8, labeller = my_labeller_NM) + 
  xlab(bquote("\n Parameter values for non-migrating fish (z-score)")) + 
  ylab(bquote("Carbon flux (mg carbon per individual per day) \n")) + scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A",  "#1B9E77")) +
  scale_fill_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A",  "#1B9E77")) + guides(color=guide_legend(nrow=2,byrow=TRUE)) 

plot_MC_NM_qgam_5000

# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("MC_NM_plot.jpg", plot = plot_MC_NM_qgam_5000, device = "jpeg", width = 170*2, height = 86*2, units = c("mm"), dpi = 500)

```


```{r plot C flux histogram, echo = FALSE, fig.height=8, fig.width=6.5, fig.cap = "Total carbon flux associated with vertically migrating and non-migrating fishes, per 1 g individual, from Monte Carlo simulations (n=1000)."}

# make into data frame
run_MC_VM_df <- as.data.frame(run_MC_VM) # nsims = 1000

# do same for NM fish

# make output a data frame
run_MC_NM_df <- as.data.frame(run_MC_NM) # nsims = 1000, edit above after NM fish MC function if different nsims value is preferred


# make data frame of total C flux results from Monte Carlo simulation
total_VM_flux <- data.frame(C_flux = run_MC_VM_df$C_flux, fish = "Vertically migrating fish", mu = mean(run_MC_VM_df$C_flux), min_95 = min_95[1], max_95 = max_95[1], row.names = NULL)

total_NM_flux <- data.frame(C_flux = run_MC_NM_df$C_flux, fish = "Non-migrating fish", mu = mean(run_MC_NM_df$C_flux), min_95 = min_95[2], max_95 = max_95[2], row.names = NULL)

total_flux <- rbind(total_VM_flux, total_NM_flux)

# calculate annual rates, if desired for an annual plot
total_VM_flux_annual <- data.frame(C_flux = run_MC_VM_df$C_flux*365, fish = "Vertically migrating fish", mu = mean(run_MC_VM_df$C_flux)*365, min_95 = min_95[1]*365, max_95 = max_95[1]*365, row.names = NULL)

total_NM_flux_annual <- data.frame(C_flux = run_MC_NM_df$C_flux*365, fish = "Non-migrating fish", mu = mean(run_MC_NM_df$C_flux)*365, min_95 = min_95[2]*365, max_95 = max_95[2]*365, row.names = NULL)

total_flux_annual <- rbind(total_VM_flux_annual, total_NM_flux_annual)

# plot histogram with VM and NM fish data overlapping in a single plot
hist_total <- ggplot(data = total_flux, aes(x = C_flux, color = fish, fill = fish)) + geom_histogram(binwidth = 0.0002, alpha = 0.5, position = "identity") + theme_bw() + theme(legend.title=element_blank(), strip.background.x = element_blank(), strip.text.x = element_text(size = 18), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18)) +
  xlab(bquote("\n Carbon flux (grams carbon per individual per day)")) + 
  ylab(bquote("Frequency from Monte Carlo simulations \n")) + geom_vline(data=total_flux, aes(xintercept=min_95, color=fish),
             linetype="dashed") + geom_vline(data=total_flux, aes(xintercept=max_95, color=fish),
             linetype="dashed") + scale_fill_manual(values = c("steelblue3", "red3")) + scale_color_manual(values = c("steelblue3", "red3"))

# removed mean line, geom_vline(data=total_flux, aes(xintercept=mu, color=fish), linetype="dashed"), for simplicity but this could be added back in if desired

# alternatively, make kernel density plot. Use this in manuscript instead of histogram (because bin widths are chosen arbitrarily in histogram)
kernel_density <- ggplot(data = total_flux, aes(C_flux, fill = fish, colour = fish)) +
  geom_density(alpha = 0.4) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", legend.text = element_text(size = 18), strip.background.x = element_blank(), strip.text.x = element_text(size = 20), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 20)) +
  xlab(bquote("\n Carbon flux (mg carbon per individual per day)")) + 
  ylab(bquote("Probability density \n")) + geom_vline(data=total_flux, aes(xintercept=min_95, color=fish),
             linetype="dashed") + geom_vline(data=total_flux, aes(xintercept=max_95, color=fish),
             linetype="dashed") + scale_fill_manual(values = c("steelblue3", "red3")) + scale_color_manual(values = c("steelblue3", "red3"))

# plot
kernel_density

# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("kernel_density.jpg", plot = kernel_density, device = "jpeg", width = 85*2.1, height = 70*2.1, units = c("mm"), dpi = 500)

```

```{r plot carbon pathways, echo = FALSE, fig.height=8, fig.width=6.5, fig.cap = "Total carbon flux associated with each carbon flux pathway, by percent of total, for migrating and non-migrating fishes."}

# use data frame generated from C.flux.function.VM and C.flux.function.NM above to obtain C flux results by pathway for each Monte Carlo simulation (run_MC_pathways_VM and run_MC_pathways_NM)

#head(run_MC_pathways_VM)
#head(run_MC_pathways_NM)

run_MC_pathways_VM_long <- 
  run_MC_pathways_VM %>%
  pivot_longer(cols = total_flux:mort_flux, names_to = "pathway", values_to = "C_flux")

run_MC_pathways_NM_long <- 
  run_MC_pathways_NM %>%
  pivot_longer(cols = total_flux:mort_flux, names_to = "pathway", values_to = "C_flux")

# add columns for fish type
run_MC_pathways_VM_long$fish = rep("aVM", length(run_MC_pathways_VM_long$C_flux)) # "a" added so that VM fish boxplot will appear first (to the left of) NM fish boxplot

run_MC_pathways_NM_long$fish = rep("NM", length(run_MC_pathways_NM_long$C_flux))

# combine VM and NM fish data into one data frame
flux_pathways_data <- rbind(run_MC_pathways_VM_long, run_MC_pathways_NM_long)

# plot absolute values of C flux (
C_pathways_plot <- ggplot(flux_pathways_data, aes(x=pathway, y=C_flux)) + 
  geom_boxplot() + facet_wrap(vars(fish), ncol = 2)

# make new data frame, convert C flux values into % of total
# first calculate for VM fish
flux_pathways_percent_VM <- tibble("total_flux_percent" = rep(NA, nsims), "R" = rep(NA, nsims), "SDA" = rep(NA, nsims), "F" = rep(NA, nsims), "X" = rep(NA, nsims), "M" = rep(NA, nsims))

for (i in 1:nsims) {
  flux_pathways_percent_VM[i,1] <- sum(run_MC_pathways_VM[i,2:6])/run_MC_pathways_VM[i,1] * 100
  flux_pathways_percent_VM[i,2] <- run_MC_pathways_VM[i,2] / run_MC_pathways_VM[i,1] * 100
  flux_pathways_percent_VM[i,3] <- run_MC_pathways_VM[i,3] / run_MC_pathways_VM[i,1] * 100
  flux_pathways_percent_VM[i,4] <- run_MC_pathways_VM[i,4] / run_MC_pathways_VM[i,1] * 100
  flux_pathways_percent_VM[i,5] <- run_MC_pathways_VM[i,5] / run_MC_pathways_VM[i,1] * 100
  flux_pathways_percent_VM[i,6] <- run_MC_pathways_VM[i,6] / run_MC_pathways_VM[i,1] * 100
}

# do same for NM fish
flux_pathways_percent_NM <- tibble("total_flux_percent" = rep(NA, nsims), "R" = rep(NA, nsims), "SDA" = rep(NA, nsims), "F" = rep(NA, nsims), "X" = rep(NA, nsims), "M" = rep(NA, nsims))

for (i in 1:nsims) {
  flux_pathways_percent_NM[i,1] <- sum(run_MC_pathways_NM[i,2:6])/run_MC_pathways_NM[i,1] * 100
  flux_pathways_percent_NM[i,2] <- run_MC_pathways_NM[i,2] / run_MC_pathways_NM[i,1] * 100
  flux_pathways_percent_NM[i,3] <- run_MC_pathways_NM[i,3] / run_MC_pathways_NM[i,1] * 100
  flux_pathways_percent_NM[i,4] <- run_MC_pathways_NM[i,4] / run_MC_pathways_NM[i,1] * 100
  flux_pathways_percent_NM[i,5] <- run_MC_pathways_NM[i,5] / run_MC_pathways_NM[i,1] * 100
  flux_pathways_percent_NM[i,6] <- run_MC_pathways_NM[i,6] / run_MC_pathways_NM[i,1] * 100
}

# remove 4 rows with NA values in VM data frame (rare occurrence),
# replace with 4 simulations that did not produce NA values
flux_pathways_percent_VM <- flux_pathways_percent_VM %>% drop_na()
flux_pathways_percent_VM <- rbind(flux_pathways_percent_VM, flux_pathways_percent_VM[1:4,])

# convert from wide to long format
flux_pathways_percent_VM_long <- 
  flux_pathways_percent_VM %>%
  pivot_longer(cols = total_flux_percent:M, names_to = "pathway", values_to = "percent")

flux_pathways_percent_NM_long <- 
  flux_pathways_percent_NM %>%
  pivot_longer(cols = total_flux_percent:M, names_to = "pathway", values_to = "percent")

# add columns for fish type
flux_pathways_percent_VM_long$fish = rep("aVM", length(flux_pathways_percent_VM_long$percent)) # added "a" so VM fish will appear before NM fish in boxplot

flux_pathways_percent_NM_long$fish = rep("NM", length(flux_pathways_percent_NM_long$percent))

# combine VM and NM fish data into one data frame
flux_pathways_percent <- rbind(flux_pathways_percent_VM_long, flux_pathways_percent_NM_long)

# filter out the "total flux" column (no need to plot total, which is always 100%)
flux_pathways_percent <- filter(flux_pathways_percent, pathway != "total_flux_percent")

# create labels
my_labeller_boxplot <- as_labeller(c(NM="Non-migrating", aVM="Vertically migrating"))

# reorder pathways so that C flux pathway boxes appears in descending order of median value in box plot for VM fish 
flux_pathways_percent$pathway <- factor(flux_pathways_percent$pathway, levels=c("R", "F", "SDA", "M", "X"))

# rename pathways for plotting (makes legend better)
flux_pathways_percent <- flux_pathways_percent %>%
  mutate(pathway_label = factor(case_when(pathway %in% "F" ~ "Egestion (F)", pathway %in% "X" ~ "Excretion (X)", pathway %in% "M" ~ "Mortality (M)", pathway %in% "R" ~ "Respiration (R)", pathway %in% "SDA" ~ "Specific dynamic action (SDA)", TRUE ~ NA_character_)))

# reorder labels for legend
flux_pathways_percent$pathway_label <- factor(flux_pathways_percent$pathway_label, levels = c("Respiration (R)", "Egestion (F)", "Specific dynamic action (SDA)", "Mortality (M)", "Excretion (X)"))

# plot C flux as percent of total for each simulation
C_pathways_plot <- ggplot(flux_pathways_percent, aes(x=pathway, y=percent, fill = pathway_label)) +
  geom_boxplot(alpha = 0.75) + scale_y_continuous(limits = c(0,100)) + scale_x_reordered() + facet_wrap(vars(fish), ncol = 2, labeller = my_labeller_boxplot) + 
  theme_bw() + theme(legend.title=element_blank(), legend.text = element_text(size = 18), legend.position = "top", strip.background.x = element_blank(), strip.text.x = element_text(size = 20), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 22), panel.spacing = unit(1.5, 'lines')) + xlab(bquote("\n Carbon flux pathway")) + 
  ylab(bquote("Percent of total carbon flux \n")) + 
    scale_fill_manual(values = c("#66A61E", "#D95F02", "#7570B3", "#E7298A", "#E6AB02")) + guides(fill=guide_legend(nrow=3,byrow=TRUE))

C_pathways_plot

# export plot to resolution and size needed using. used preview to save as 170 mm wide for journal requirements
ggsave("C_pathways.jpg", plot = C_pathways_plot, device = "jpeg", width = 85*2, height = 69*2, units = c("mm"), dpi = 500)

```

Repeat model simulation but with a 10 g fish instead of a 1 g fish. 

```{r generate data for IPP results with 10g VM fish, eval=FALSE, echo = FALSE}

# this code chunk determines how the parameter sensitivities are affected if modeling a 10 g instead of a 1 g individual fish

# carbon flux as total, per individual
run_MC_VM_10g <- MC_func_VM(nsims=1000, W_w_f_VM = 10, Wref = 1000, Tref = 15)[[1]] # 10g fish, reference weight (for centered regression) = 10,000 mg, nsims = 1000 (keeping Wref at 1000 doesn't affect results much)

mean(run_MC_VM_10g[,1]) # mean doesn't change whether I use Wref = 1000 or 10,000 (very slightly higher when Wref = 1000 than when Wref = 10,000). Notice that mean is about 5.2 times greater than for a 1 g fish (mean C flux for a 10 g fish is 17.3, divided by mean C flux for a 1 g fish is 3.3, equals 5.2). It makes sense that C flux is not 10 x greater because larger animals respire less per unit mass than smaller animals due to allometry

run_MC_VM_10g_df <- as.data.frame(run_MC_VM_10g)

# IPP for 10 g VM fish, to see if there are any differences in sensitivities. Could also make the tables that show which parameters have the highest % change between the minimum and maximum C flux estimate for each parameter vector. 

a0_output_10g <- data.frame(par_name = "a0", par_value = a0_vector, C_flux = NA)
for (i in 1:length(a0_vector)) {
  a0_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0_vector[i], a1=a1, a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] # units of mg. The [1] specifies to use only the first element in the output of C.flux.function.VM
}

a1_output_10g <- data.frame(par_name = "a1", par_value = a1_vector, C_flux = NA)
for (i in 1:length(a1_vector)) {
  a1_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1_vector[i], a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

a2_output_10g <- data.frame(par_name = "a2", par_value = a2_vector, C_flux = NA)
for (i in 1:length(a2_vector)) {
  a2_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2_vector[i], a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

a3_output_10g <- data.frame(par_name = "a3", par_value = a3_vector, C_flux = NA)
for (i in 1:length(a3_vector)) {
  a3_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3_vector[i], H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

TT_epipelagic_output_10g <- data.frame(par_name = "TT_epipelagic", par_value = TT_epipelagic_vector, C_flux = NA)
for (i in 1:length(TT_epipelagic_vector)) {
  TT_epipelagic_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic_vector[i], TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1]
}

TT_mesopelagic_output_10g <- data.frame(par_name = "TT_mesopelagic", par_value = TT_mesopelagic_vector, C_flux = NA)
for (i in 1:length(TT_mesopelagic_vector)) {
  TT_mesopelagic_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic_vector[i], TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

TT_mean_output_10g <- data.frame(par_name = "TT_mean", par_value = TT_mean_vector, C_flux = NA)
for (i in 1:length(TT_mean_vector)) {
  TT_mean_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean_vector[i],  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

activity_factor_resting_output_10g <- data.frame(par_name = "activity_factor_resting", par_value = activity_factor_resting_vector, C_flux = NA)
for (i in 1:length(activity_factor_resting_vector)) {
  activity_factor_resting_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting_vector[i], activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

activity_factor_migrating_output_10g <- data.frame(par_name = "activity_factor_migrating", par_value = activity_factor_migrating_vector, C_flux = NA)
for (i in 1:length(activity_factor_migrating_vector)) {
  activity_factor_migrating_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating_vector[i], activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

activity_factor_foraging_output_10g <- data.frame(par_name = "activity_factor_foraging", par_value = activity_factor_foraging_vector, C_flux = NA)
for (i in 1:length(activity_factor_foraging_vector)) {
  activity_factor_foraging_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging_vector[i], time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

time_resting_output_10g <- data.frame(par_name = "time_resting", par_value = time_resting_vector, C_flux = NA)
for (i in 1:length(time_resting_vector)) {
  time_resting_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting_vector[i], G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

G_VM_output_10g <- data.frame(par_name = "G_VM", par_value = G_VM_vector, C_flux = NA)
for (i in 1:length(G_VM_vector)) { 
  G_VM_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM_vector[i], prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_SDA_output_10g <- data.frame(par_name = "prop_SDA", par_value = prop_SDA_vector, C_flux = NA)
for (i in 1:length(prop_SDA_vector)) {
  prop_SDA_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA_vector[i], prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_egestion_output_10g <- data.frame(par_name = "prop_egestion", par_value = prop_egestion_vector, C_flux = NA)
for (i in 1:length(prop_egestion_vector)) {
  prop_egestion_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion_vector[i], prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_excretion_output_10g <- data.frame(par_name = "prop_excretion", par_value = prop_excretion_vector, C_flux = NA)
for (i in 1:length(prop_excretion_vector)) {
  prop_excretion_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion_vector[i], theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

theta_output_10g <- data.frame(par_name = "theta", par_value = theta_vector, C_flux = NA)
for (i in 1:length(theta_vector)) {
  theta_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta_vector[i], peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}


# Note: the optim() function occasionally comes up with a value that falls lower or higher than the line where the vast majority of points fall on, so we removed points with a C flux < 12 and > 14

peakTime_output_10g_unfiltered <- data.frame(par_name = "peakTime", par_value = peakTime_vector, C_flux = NA)
for (i in 1:length(peakTime_vector)) {
  peakTime_output_10g_unfiltered[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime_vector[i], timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

# filter out values that are too high or too low
peakTime_output_10g_fewer_rows <- peakTime_output_10g_unfiltered %>% filter(C_flux>12 & C_flux<14)

# create this number of additional rows to add to nrows = nsims 
number_rows_to_add <- nsims - length(peakTime_output_10g_fewer_rows$C_flux)

# create random list of values that will correspond to the row numbers selected to duplicate
rows_to_add <- sample(x = 1:number_rows_to_add, size = number_rows_to_add, replace = FALSE)

# create new data frame with additional rows adding up to nsims
peakTime_output_10g <- rbind(peakTime_output_10g_fewer_rows, peakTime_output_10g_fewer_rows[rows_to_add,])

timeTo90_output_10g <- data.frame(par_name = "timeTo90", par_value = timeTo90_vector, C_flux = NA)
for (i in 1:length(timeTo90_vector)) {
  timeTo90_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90_vector[i], X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

X_r_output_10g <- data.frame(par_name = "X_r", par_value = X_r_vector, C_flux = NA)
for (i in 1:length(X_r_vector)) {
  X_r_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r_vector[i], X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

X_e_output_10g <- data.frame(par_name = "X_e", par_value = X_e_vector, C_flux = NA)
for (i in 1:length(X_e_vector)) {
  X_e_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e_vector[i], mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

mu_output_10g <- data.frame(par_name = "mu", par_value = mu_vector, C_flux = NA)
for (i in 1:length(mu_vector)) {
  mu_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu_vector[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Q_ox_kJ_g_O2_output_10g <- data.frame(par_name = "Q_ox_kJ_g_O2", par_value = Q_ox_kJ_g_O2_vector, C_flux = NA)
for (i in 1:length(Q_ox_kJ_g_O2_vector)) {
  Q_ox_kJ_g_O2_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2_vector[i], RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

RQ_output_10g <- data.frame(par_name = "RQ", par_value = RQ_vector, C_flux = NA)
for (i in 1:length(RQ_vector)) {
  RQ_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ_vector[i], Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Dmax_output_10g <- data.frame(par_name = "Dmax", par_value = Dmax_vector, C_flux = NA)
for (i in 1:length(Dmax_vector)) {
  Dmax_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax_vector[i], Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

Dmin_output_10g <- data.frame(par_name = "Dmin", par_value = Dmin_vector, C_flux = NA)
for (i in 1:length(Dmin_vector)) {
  Dmin_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin_vector[i], B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

B_output_10g <- data.frame(par_name = "B", par_value = B_vector, C_flux = NA)
for (i in 1:length(B_vector)) {
  B_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B_vector[i], S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

S_output_10g <- data.frame(par_name = "S", par_value = S_vector, C_flux = NA)
for (i in 1:length(S_vector)) {
  S_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S_vector[i], energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

energy_in_pellet_output_10g <- data.frame(par_name = "energy_in_pellet", par_value = energy_in_pellet_vector, C_flux = NA)
for (i in 1:length(energy_in_pellet_vector)) {
  energy_in_pellet_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2 , a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet_vector[i], C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

C_in_pellet_output_10g <- data.frame(par_name = "C_in_pellet", par_value = C_in_pellet_vector, C_flux = NA)
for (i in 1:length(C_in_pellet_vector)) {
  C_in_pellet_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet_vector[i],  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

proportion_egestion_below_150m_output_10g <- data.frame(par_name = "proportion_egestion_below_150m", par_value = proportion_egestion_below_150m_vector, C_flux = NA)
for (i in 1:length(proportion_egestion_below_150m_vector)) {
  proportion_egestion_below_150m_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m_vector[i], C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

C_c_vm_output_10g <- data.frame(par_name = "C_c_vm", par_value = C_c_vm_vector, C_flux = NA)
for (i in 1:length(C_c_vm_vector)) {
  C_c_vm_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm_vector[i], prop_mortality_below_150m=prop_mortality_below_150m)[1] 
}

prop_mortality_below_150m_output_10g <- data.frame(par_name = "prop_mortality_below_150m", par_value = prop_mortality_below_150m_vector, C_flux = NA)
for (i in 1:length(prop_mortality_below_150m_vector)) {
  prop_mortality_below_150m_output_10g[i,3] <- C.flux.function.VM(W_w_f_VM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_VM, TT_epipelagic=TT_epipelagic, TT_mesopelagic=TT_mesopelagic, TT_mean=TT_mean,  activity_factor_resting=activity_factor_resting, activity_factor_migrating=activity_factor_migrating, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, G_VM=G_VM, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, theta=theta, peakTime=peakTime, timeTo90=timeTo90, X_r=X_r, X_e=X_e, mu=mu, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, Dmax=Dmax, Dmin=Dmin, B=B, S=S, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet,  proportion_egestion_below_150m=proportion_egestion_below_150m, C_c_vm=C_c_vm, prop_mortality_below_150m=prop_mortality_below_150m_vector[i])[1] 
}

```

```{r plot IPP results for a 10 g VM fish, eval=FALSE, echo = FALSE}
## Plot IPP results for a 10 g VM fish

# make data frame of all parameter and C flux values
IPP_VM_10g <- rbind(a0_output_10g, a1_output_10g, a2_output_10g, a3_output_10g, TT_epipelagic_output_10g, TT_mesopelagic_output_10g, TT_mean_output_10g, activity_factor_resting_output_10g, activity_factor_foraging_output_10g, activity_factor_migrating_output_10g, time_resting_output_10g, Dmax_output_10g, Dmin_output_10g, B_output_10g, S_output_10g, prop_SDA_output_10g, prop_egestion_output_10g, prop_excretion_output_10g, G_VM_output_10g, theta_output_10g, peakTime_output_10g, timeTo90_output_10g, X_r_output_10g, X_e_output_10g, mu_output_10g, Q_ox_kJ_g_O2_output_10g, RQ_output_10g, energy_in_pellet_output_10g, C_in_pellet_output_10g, proportion_egestion_below_150m_output_10g, C_c_vm_output_10g, prop_mortality_below_150m_output_10g)

# re-order factors for plotting in same order as parameters appear in equations in text
IPP_VM_10g$par_name <- factor(IPP_VM_10g$par_name, levels = c("a0", "a1", "a2", "a3", "TT_epipelagic", "TT_mesopelagic", "TT_mean", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_migrating", "activity_factor_resting", "time_resting", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM", "prop_SDA", "peakTime", "timeTo90", "prop_egestion", "energy_in_pellet", "C_in_pellet", "proportion_egestion_below_150m",  "prop_excretion", "X_r", "X_e", "C_c_vm", "mu", "prop_mortality_below_150m"))

# create parameter groups 
resp_flux_IPP <- c("a0", "a1", "a2", "a3", "TT_epipelagic", "TT_mesopelagic", "TT_mean", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_migrating", "activity_factor_resting", "time_resting", "theta", "Dmax", "Dmin", "B", "S", "RQ", "G_VM")
SDA_flux_IPP <- c("prop_SDA", "peakTime", "timeTo90")
eg_flux_IPP <- c("prop_egestion", "energy_in_pellet", "C_in_pellet", "proportion_egestion_below_150m")
ex_flux_IPP <- c("prop_excretion", "X_r", "X_e")
mort_flux_IPP <- c("C_c_vm", "mu", "prop_mortality_below_150m")

# add column for color coding, by parameter group
IPP_VM_10g <- IPP_VM_10g %>%
  mutate(group = factor(case_when(par_name %in% resp_flux_IPP ~ "respiratory flux and growth", par_name %in% SDA_flux_IPP ~ "specific dynamic action flux", par_name %in% eg_flux_IPP ~ "egestion flux", par_name %in% ex_flux_IPP ~ "excretion flux", par_name %in% mort_flux_IPP ~ "mortality flux", TRUE ~ NA_character_)))

# re-order levels for legend 
IPP_VM_10g$group <- factor(IPP_VM$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux"))

# create labels for each parameter's plot
my_labeller_IPP_VM <- as_labeller(c(activity_factor_foraging="A[f]", activity_factor_migrating="A[m]", activity_factor_resting="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", a3="alpha[3]", B="B", C_c_vm="C[c]", C_in_pellet="C[p]", Dmax="D[max]", Dmin="D[min]", energy_in_pellet="e[p]", proportion_egestion_below_150m="E[F]", G_VM="G[VM]", prop_mortality_below_150m="E[mu]", mu="mu", prop_egestion="phi[F]", prop_SDA="phi[SDA]", prop_excretion="phi[X]", Q_ox_kJ_g_O2="Q[ox]", RQ="R[Q]", S="S", timeTo90="t[90]", TT_epipelagic="T[epi]", TT_mean="T[mean]", TT_mesopelagic="T[meso]", peakTime="t[peak]", time_resting="t[r]", theta="theta", X_e="E[X]", X_r="X[r]"), default = label_parsed)

# get axis tick marks to work with new package ggh4x with additional options for faceted plots

position_scales_VM_10g <- list(scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a0")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a0")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a1")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a1")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a2")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a3")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="a3")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_epipelagic")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_epipelagic")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_mesopelagic")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_mesopelagic")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_mean")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="TT_mean")])),2)),
                        scale_x_continuous(breaks = c(12.3, 15.0)), # hard coded in... this code wasn't working: signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_foraging")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_foraging")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_migrating")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_migrating")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_resting")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="activity_factor_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="time_resting")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="time_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="theta")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="theta")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="Dmax")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="Dmax")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="Dmin")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="Dmin")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="B")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="B")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="S")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="S")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="RQ")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="RQ")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="G_VM")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="G_VM")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_SDA")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_SDA")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="peakTime")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="peakTime")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="timeTo90")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="timeTo90")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_egestion")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_egestion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="energy_in_pellet")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="energy_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="C_in_pellet")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="C_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="proportion_egestion_below_150m")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="proportion_egestion_below_150m")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_excretion")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_excretion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="X_r")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="X_r")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="X_e")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="X_e")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="C_c_vm")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="C_c_vm")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="mu")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="mu")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_mortality_below_150m")]), max(IPP_VM_10g$par_value[which(IPP_VM_10g$par_name=="prop_mortality_below_150m")])),2)))

# plot IPP results for VM fish. 
plot_IPP_VM_10g <- ggplot(data = IPP_VM_10g, aes(x = par_value, y = C_flux)) + scale_y_continuous(breaks = c(0.00, 22), limits = c(0.00, 22)) + geom_line(data = IPP_VM_10g, aes(x = par_value, y = C_flux, color = group), alpha = 3, linewidth = 1) + theme_bw() + theme(legend.title=element_blank(), legend.text = element_text(size=14), legend.position = "top",  strip.background.x = element_blank(), strip.text.x = element_text(size = 18), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18), panel.spacing = unit(2.5, 'lines'), plot.margin = unit(c(1, 1, 1, 1), units = "line")) + facet_wrap(vars(par_name), ncol = 8, scales = "free_x", labeller = my_labeller_IPP_VM) + xlab(bquote("\n Parameter values for vertically migrating fish (units vary)")) + ylab(bquote("Carbon flux (mg carbon per individual 10 g fish per day) \n")) + facetted_pos_scales(x = position_scales_VM_10g) + scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A")) + guides(color = guide_legend(nrow=2,byrow=TRUE))

# plot
plot_IPP_VM_10g

# make data frame to find % change in C flux from min to max of each par value range
IPP_VM_sensitivity_10g <- IPP_VM_10g %>%
  group_by(par_name) %>%
  summarise(
    min_C_flux_by_par = min(C_flux),
    max_C_flux_by_par = max(C_flux)
  ) %>%
  arrange(par_name)

IPP_VM_sensitivity_10g$percent_change_C <- round((IPP_VM_sensitivity_10g$max_C_flux_by_par - IPP_VM_sensitivity_10g$min_C_flux_by_par) / IPP_VM_sensitivity_10g$min_C_flux_by_par * 100, 1)

# round other columns to 3 sig figs
IPP_VM_sensitivity_10g$min_C_flux_by_par <- signif(IPP_VM_sensitivity_10g$min_C_flux_by_par, 3)
IPP_VM_sensitivity_10g$max_C_flux_by_par <- signif(IPP_VM_sensitivity_10g$max_C_flux_by_par, 3)

# coerce from tibble to data frame to allow column and row name editing
IPP_VM_sensitivity_table_10g <- as.data.frame(IPP_VM_sensitivity_10g)

# already created par_names, see par_names_VM from above

IPP_VM_sensitivity_table_10g$par_name <- par_names_VM

IPP_VM_sensitivity_table_10g <- IPP_VM_sensitivity_table_10g %>% arrange(desc(percent_change_C))

colnames(IPP_VM_sensitivity_table_10g) <- c("Parameter name", "Minimum C flux", "Maximum C flux", "Percent change in C flux")


kable(IPP_VM_sensitivity_table_10g, caption = "Percent change in vertically migrating fish carbon flux from the minimum to the maximum parameter value, based on individual parameter perturbation calculations, for a 10 g fish. Minimum and maximum parameter values are based on the literature and, where knowledge gaps remain, educated guesses of feasible parameter ranges.", escape = FALSE) 


```


```{r generate data for IPP with a 10 g NM fish, eval = FALSE, echo = FALSE}

H_NM  <- 0
H_NM_min <- 0
H_NM_max <- 0
H_NM_range <- c(H_NM_min, H_NM_max)

G_NM <- 0.007
G_NM_min <-  G_NM * 0.5
G_NM_max <- G_NM * 1.5
G_NM_range <- c(G_NM_min, G_NM_max)

prop_non_detrital_NM_prey  <- 0.7
prop_non_detrital_NM_prey_min  <- 0.7 * 0.8
prop_non_detrital_NM_prey_max   <- 0.7 * 1.2
prop_non_detrital_NM_prey_range  <- c(prop_non_detrital_NM_prey_min, prop_non_detrital_NM_prey_max)

C_c_nm <- 0.143 # same as for VM fish 
C_c_nm_min <- 0.038
C_c_nm_max <- 0.248
C_c_nm_range <- c(C_c_nm_min, C_c_nm_max)

# set parameter ranges for plots (some ranges are already assigned in VM fish code above)

G_NM_vector <- seq(from = G_NM_range[1], to =  G_NM_range[2],
                                      length.out = 1000)

prop_non_detrital_NM_prey_vector <- seq(from = prop_non_detrital_NM_prey_range[1], to =  prop_non_detrital_NM_prey_range[2], length.out = 1000)

C_c_nm_vector <- seq(from = C_c_nm_range[1], to =  C_c_nm_range[2], 
                 length.out = 1000)


run_MC_NM_10g <- MC_func_NM(nsims=1000, W_w_f_NM = 10, Wref = 1000, Tref = 15, output_VM = run_MC_VM_10g_df)[[1]] # 10g fish, reference weight (for centered regression) = 10,000 mg, nsims = 1000

mean(run_MC_NM_10g[,1]) # resulting C flux mean is over 5x higher with a 10 g fish, which makes sense (allometry causes this difference to be < 10x)

## generate C flux values for a 10g instead of 1 g fish
a0_output_NM_10g <- data.frame(par_name = "a0", par_value = a0_vector, C_flux = NA)
for (i in 1:length(a0_vector)) {
  a0_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0_vector[i], a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] # units of mg. The [1] specifies to use only the first element in the output of C.flux.function.NM
}

a1_output_NM_10g <- data.frame(par_name = "a1", par_value = a1_vector, C_flux = NA)
for (i in 1:length(a1_vector)) {
  a1_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1_vector[i], a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

a2_output_NM_10g <- data.frame(par_name = "a2", par_value = a2_vector, C_flux = NA)
for (i in 1:length(a2_vector)) {
  a2_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2_vector[i], a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

a3_output_NM_10g <- data.frame(par_name = "a3", par_value = a3_vector, C_flux = NA)
for (i in 1:length(a3_vector)) {
  a3_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3_vector[i], H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

TT_mesopelagic_output_NM_10g <- data.frame(par_name = "TT_mesopelagic", par_value = TT_mesopelagic_vector, C_flux = NA)
for (i in 1:length(TT_mesopelagic_vector)) {
  TT_mesopelagic_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic_vector[i], activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

activity_factor_resting_output_NM_10g <- data.frame(par_name = "activity_factor_resting", par_value = activity_factor_resting_vector, C_flux = NA)
for (i in 1:length(activity_factor_resting_vector)) {
  activity_factor_resting_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting_vector[i], activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

activity_factor_foraging_output_NM_10g <- data.frame(par_name = "activity_factor_foraging", par_value = activity_factor_foraging_vector, C_flux = NA)
for (i in 1:length(activity_factor_foraging_vector)) {
  activity_factor_foraging_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging_vector[i], time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

time_resting_output_NM_10g <- data.frame(par_name = "time_resting", par_value = time_resting_vector, C_flux = NA)
for (i in 1:length(time_resting_vector)) {
  time_resting_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting_vector[i], prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

prop_SDA_output_NM_10g <- data.frame(par_name = "prop_SDA", par_value = prop_SDA_vector, C_flux = NA)
for (i in 1:length(prop_SDA_vector)) {
  prop_SDA_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA_vector[i], prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

prop_egestion_output_NM_10g <- data.frame(par_name = "prop_egestion", par_value = prop_egestion_vector, C_flux = NA)
for (i in 1:length(prop_egestion_vector)) {
  prop_egestion_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion_vector[i], prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

prop_excretion_output_NM_10g <- data.frame(par_name = "prop_excretion", par_value = prop_excretion_vector, C_flux = NA)
for (i in 1:length(prop_excretion_vector)) {
  prop_excretion_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion_vector[i], G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

G_NM_output_NM_10g <- data.frame(par_name = "G_NM", par_value = G_NM_vector, C_flux = NA)
for (i in 1:length(G_NM_vector)) {
  G_NM_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM_vector[i], theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

theta_output_NM_10g <- data.frame(par_name = "theta", par_value = theta_vector, C_flux = NA)
for (i in 1:length(theta_vector)) {
  theta_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta_vector[i], mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

mu_output_NM_10g <- data.frame(par_name = "mu", par_value = mu_vector, C_flux = NA)
for (i in 1:length(mu_vector)) {
  mu_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu_vector[i], prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

prop_non_detrital_NM_prey_output_NM_10g <- data.frame(par_name = "Z", par_value = prop_non_detrital_NM_prey_vector, C_flux = NA)
for (i in 1:length(prop_non_detrital_NM_prey_vector)) {
  prop_non_detrital_NM_prey_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey_vector[i], X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

X_r_output_NM_10g <- data.frame(par_name = "X_r", par_value = X_r_vector, C_flux = NA)
for (i in 1:length(X_r_vector)) {
  X_r_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r_vector[i], Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

Q_ox_kJ_g_O2_output_NM_10g <- data.frame(par_name = "Q_ox_kJ_g_O2", par_value = Q_ox_kJ_g_O2_vector, C_flux = NA)
for (i in 1:length(Q_ox_kJ_g_O2_vector)) {
  Q_ox_kJ_g_O2_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2_vector[i], RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

RQ_output_NM_10g <- data.frame(par_name = "RQ", par_value = RQ_vector, C_flux = NA)
for (i in 1:length(RQ_vector)) {
  RQ_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ_vector[i], energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

energy_in_pellet_output_NM_10g <- data.frame(par_name = "energy_in_pellet", par_value = energy_in_pellet_vector, C_flux = NA)
for (i in 1:length(energy_in_pellet_vector)) {
  energy_in_pellet_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet_vector[i], C_in_pellet=C_in_pellet, C_c_nm=C_c_nm)[1] 
}

C_in_pellet_output_NM_10g <- data.frame(par_name = "C_in_pellet", par_value = C_in_pellet_vector, C_flux = NA)
for (i in 1:length(C_in_pellet_vector)) {
  C_in_pellet_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet_vector[i], C_c_nm=C_c_nm)[1] 
}

C_c_nm_output_NM_10g <- data.frame(par_name = "C_c_nm", par_value = C_c_nm_vector, C_flux = NA)
for (i in 1:length(C_c_nm_vector)) {
  C_c_nm_output_NM_10g[i,3] <- C.flux.function.NM(W_w_f_NM=10, Wref=1000, Tref=15, a0=a0, a1=a1, a2=a2, a3=a3, H_VM_or_NM=H_NM, TT_mesopelagic=TT_mesopelagic, activity_factor_resting=activity_factor_resting, activity_factor_foraging=activity_factor_foraging, time_resting=time_resting, prop_SDA=prop_SDA, prop_egestion=prop_egestion, prop_excretion=prop_excretion, G_NM=G_NM, theta=theta, mu=mu, prop_non_detrital_NM_prey=prop_non_detrital_NM_prey, X_r=X_r, Q_ox_kJ_g_O2=Q_ox_kJ_g_O2, RQ=RQ, energy_in_pellet=energy_in_pellet, C_in_pellet=C_in_pellet, C_c_nm=C_c_nm_vector[i])[1] 
}


```

```{r plot NM fish IPP results with a 10 g fish, eval=FALSE, echo = FALSE}

# make data frame of all parameter and C flux values (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
IPP_NM_10g <- rbind(a0_output_NM_10g, a1_output_NM_10g, a2_output_NM_10g, TT_mesopelagic_output_NM_10g, activity_factor_resting_output_NM_10g, activity_factor_foraging_output_NM_10g, time_resting_output_NM_10g, prop_SDA_output_NM_10g, prop_egestion_output_NM_10g, prop_excretion_output_NM_10g, G_NM_output_NM_10g, theta_output_NM_10g, X_r_output_NM_10g, mu_output_NM_10g, prop_non_detrital_NM_prey_output_NM_10g, Q_ox_kJ_g_O2_output_NM_10g, RQ_output_NM_10g, energy_in_pellet_output_NM_10g, C_in_pellet_output_NM_10g, C_c_nm_output_NM_10g)

# re-order factors for plotting in same order as parameters appear in equations in text (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
IPP_NM_10g$par_name <- factor(IPP_NM_10g$par_name, levels = c("a0", "a1", "a2", "TT_mesopelagic", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_resting", "time_resting", "theta", "RQ", "G_NM", "prop_SDA", "prop_egestion", "energy_in_pellet", "C_in_pellet", "prop_excretion", "X_r", "C_c_nm", "mu", "Z"))

# create parameter groups (note: removed a3 because it is multiplied by 0 for non-migrating fish by definition)
resp_flux_IPP <- c("a0", "a1", "a2", "TT_mesopelagic", "Q_ox_kJ_g_O2", "activity_factor_foraging", "activity_factor_resting", "time_resting", "theta", "RQ", "G_NM")
SDA_flux_IPP <- c("prop_SDA")
eg_flux_IPP <- c("prop_egestion", "energy_in_pellet", "C_in_pellet")
ex_flux_IPP <- c("prop_excretion", "X_r")
mort_flux_IPP <- c("C_c_nm", "mu")
all_fluxes <- c("Z")

# add column for color coding, by parameter group
IPP_NM_10g <- IPP_NM_10g %>%
  mutate(group = factor(case_when(par_name %in% resp_flux_IPP ~ "respiratory flux and growth", par_name %in% SDA_flux_IPP ~ "specific dynamic action flux", par_name %in% eg_flux_IPP ~ "egestion flux", par_name %in% ex_flux_IPP ~ "excretion flux", par_name %in% mort_flux_IPP ~ "mortality flux", par_name %in% all_fluxes ~ "ratio of non-detrital prey",  TRUE ~ NA_character_)))

# re-order levels for legend 
IPP_NM_10g$group <- factor(IPP_NM$group, levels = c("respiratory flux and growth", "specific dynamic action flux", "egestion flux", "excretion flux", "mortality flux", "ratio of non-detrital prey"))

# create labels for each parameter's plot
my_labeller_IPP_NM_10g <- as_labeller(c(activity_factor_foraging="A[f]", activity_factor_resting="A[r]", a0="alpha[0]", a1="alpha[1]", a2="alpha[2]", B="B", C_c_nm="C[c]", C_in_pellet="C[p]", energy_in_pellet="e[p]", G_NM="G[NM]", mu="mu", prop_egestion="phi[F]", prop_SDA="phi[SDA]", prop_excretion="phi[X]", Q_ox_kJ_g_O2="Q[ox]", RQ="R[Q]", S="S", TT_mesopelagic="T[meso]", time_resting="t[r]", theta="theta", X_r="X[r]", Z="Z"), default = label_parsed)

# get axis tick marks to work with new package ggh4x with additional options for faceted plots
position_scales_NM <- list(scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a0")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a0")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a1")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a1")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a2")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="a2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="TT_mesopelagic")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="TT_mesopelagic")])),2)),
                        scale_x_continuous(breaks = c(12.3, 15.0)), # hard coded in... this code wasn't working: signif(c(min(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")]), max(IPP_NM$par_value[which(IPP_NM$par_name=="Q_ox_kJ_g_O2")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="activity_factor_foraging")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="activity_factor_foraging")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="activity_factor_resting")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="activity_factor_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="time_resting")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="time_resting")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="theta")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="theta")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="RQ")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="RQ")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="G_NM")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="G_NM")])),2)),
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_SDA")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_SDA")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_egestion")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_egestion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="energy_in_pellet")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="energy_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="C_in_pellet")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="C_in_pellet")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_excretion")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="prop_excretion")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="X_r")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="X_r")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="C_c_nm")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="C_c_nm")])),2)), 
                        scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="mu")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="mu")])),2)),                                            scale_x_continuous(breaks = signif(c(min(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="Z")]), max(IPP_NM_10g$par_value[which(IPP_NM_10g$par_name=="Z")])),2)))

# plot IPP results for NM fish
plot_IPP_NM_10g <- ggplot(data = IPP_NM_10g, aes(x = par_value, y = C_flux)) + scale_y_continuous(breaks = c(0, 12), limits = c(0, 12)) +
  geom_line(data = IPP_NM_10g, aes(x = par_value, y = C_flux, color = group), alpha = 3, linewidth = 1) + theme_bw() + theme(legend.title=element_blank(), legend.position = "top", strip.background.x = element_blank(), legend.text = element_text(size = 14), strip.text.x = element_text(size = 18), panel.border = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"), text = element_text(size = 18), panel.spacing = unit(2.5, 'lines'), plot.margin = unit(c(1, 1, 1, 1), units = "line")) +
  facet_wrap(vars(par_name), ncol = 8, scales = "free_x", labeller = my_labeller_IPP_NM_10g) +
  xlab(bquote("\n Parameter values for non-migrating fishes (units vary)")) + ylab(bquote("Carbon flux (mg carbon per 10 g individual per day) \n")) + facetted_pos_scales(x = position_scales_NM) + scale_color_manual(values = c("#66A61E", "#7570B3", "#D95F02", "#E6AB02", "#E7298A",  "#1B9E77")) + guides(color = guide_legend(nrow=2,byrow=TRUE))

# print plot
plot_IPP_NM_10g

# make data frame to find % change in C flux from min to max of each par value range
IPP_NM_sensitivity_10g <- IPP_NM %>%
  group_by(par_name) %>%
  summarise(
    min_C_flux_by_par = min(C_flux),
    max_C_flux_by_par = max(C_flux)
  ) %>%
  arrange(par_name)

IPP_NM_sensitivity_10g$percent_change_C <- round((IPP_NM_sensitivity_10g$max_C_flux_by_par - IPP_NM_sensitivity_10g$min_C_flux_by_par) / IPP_NM_sensitivity_10g$min_C_flux_by_par * 100, 1)

# round other columns to 3 sig figs
IPP_NM_sensitivity_10g$min_C_flux_by_par <- signif(IPP_NM_sensitivity_10g$min_C_flux_by_par, 3)
IPP_NM_sensitivity_10g$max_C_flux_by_par <- signif(IPP_NM_sensitivity_10g$max_C_flux_by_par, 3)

# coerce from tibble to data frame to allow column and row name editing
IPP_NM_sensitivity_table_10g <- as.data.frame(IPP_NM_sensitivity_10g)

par_names_NM <- c(
  "$\\alpha_0$",
  "$\\alpha_1$",
  "$\\alpha_2$",
  "$T_{meso}$",
  "$Q_{ox}$",
  "$A_{f}$",
  "$A_{r}$",
  "$t_{r}$",
  "$\\theta$",
  "$RQ$",
  "$G_{NM}$",
  "$\\phi_{SDA}$",
  "$\\phi_{F}$",
  "$e_{p}$",
  "$C_{p}$",
  "$\\phi_{X}$",
  "$X_{r}$", 
  "$C_{c}$",
  "$\\mu$",
  "$Z$"
  )

IPP_NM_sensitivity_table_10g$par_name <- par_names_NM

IPP_NM_sensitivity_table_10g <- IPP_NM_sensitivity_table_10g %>% arrange(desc(percent_change_C))

colnames(IPP_NM_sensitivity_table_10g) <- c("Parameter name", "Minimum C flux", "Maximum C flux", "Percent change in C flux")

kable(IPP_NM_sensitivity_table_10g, caption = "Percent change in a 10g non-migrating fish carbon flux from the minimum to the maximum parameter value, based on individual parameter perturbation calculations. Minimum and maximum parameter values are based on the literature and, where knowledge gaps remain, educated guesses of feasible parameter ranges.", escape = FALSE) 
```

\vspace{0.25in}

# Discussion 

```{r back of the envelope calculation for discussion}
# minimum VM fish C flux for region
# minimum fish density in mg/m^2 * minimum C flux per fish (as % of body weight, unitless, and based on calculations of a 1 g fish) * maximum capture efficiency
min_fish_C_flux <- 500 * 0.000012 * (1/0.5) # 0.000014 g C/ m^2 or 0.014 mg C / m^2

# maximum VM fish C flux for region 
max_fish_C_flux <- 5200 * 0.000076 * (1/0.14) # 0.0032 g C/ m^2 or 3.2 mg C / m^2

# min contribution by fish (using max contribution by gravitational POC) 
# POC data from min estimate in November in Scotia Sea (in mg/m^2)
min_percent_fish_contribution <- min_fish_C_flux / (min_fish_C_flux+3.2) * 100 # 0.37%
  
# min contribution by fish (using max contribution by gravitational POC) 
# POC data from min estimate in November in Scotia Sea
max_percent_fish_contribution <- max_fish_C_flux / (max_fish_C_flux+0.6) * 100 # 82%

# using POC data from January in Scotia Sea (might higher POC flux range)
min_percent_fish_contribution_higher_POC <- min_fish_C_flux / (min_fish_C_flux+13.1) * 100 # 0.09%
max_percent_fish_contribution_higher_POC <- max_fish_C_flux / (max_fish_C_flux+7.1) * 100 # 28%
  
```

# R packages used and non-journal article sources consulted

Bates D, Maechler M, Bolker B, Walker S (2014). lme4: Linear Mixed-Effects Models Using Eigen and S4. R package version 1.1-7, URL http://CRAN.R-project.org/package=lme4.

Fasiolo M, Wood SN, Zaffran M, Goude Y, Nedellec R (2020). qgam: Smooth Additive Quantile Regression Models. R package version 1.3.2, URL https://cran.r-project.org/web/packages/qgam/qgam.pdf

Nelson, J. S. Fishes of the World (Wiley, 2006).

Journal article citations were formatted using Zotero.

# Co-authors of manuscript
Tim Essington (UW)
Joel Llopiz (WHOI)
Ray Hilborn (UW)

# R version info

## sessionInfo()

#R version 4.2.2 (2022-10-31)
#Platform: aarch64-apple-darwin20 (64-bit)
#Running under: macOS Ventura 13.4

#Matrix products: default
#LAPACK: /Library/Frameworks/R.framework/Versions/4.2-arm64/Resources/lib/libRlapack.dylib

#locale:
#[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

#attached base packages:
#[1] stats     graphics  grDevices utils     datasets  methods   base     

#other attached packages:
# [1] tidytext_0.4.0 gcookbook_2.0  ggh4x_0.2.3    quantreg_5.94  SparseM_1.81   ggplot2_3.4.0 
# [7] stringr_1.4.1  dplyr_1.0.10   tidyr_1.2.1    MASS_7.3-58.1  qgam_1.3.4     mgcv_1.8-41   
#[13] nlme_3.1-160   mvtnorm_1.1-3  here_1.0.1     knitr_1.41    

#loaded via a namespace (and not attached):
# [1] Rcpp_1.0.9         lattice_0.20-45    rprojroot_2.0.3    digest_0.6.30     
# [5] foreach_1.5.2      utf8_1.2.2         mime_0.12          R6_2.5.1          
# [9] plyr_1.8.8         MatrixModels_0.5-1 evaluate_0.18      highr_0.9         
#[13] pillar_1.8.1       rlang_1.0.6        rstudioapi_0.14    Matrix_1.5-1      
#[17] rmarkdown_2.18     textshaping_0.3.6  labeling_0.4.2     splines_4.2.2     
#[21] munsell_0.5.0      shiny_1.7.3        compiler_4.2.2     janeaustenr_1.0.0 
#[25] httpuv_1.6.6       xfun_0.35          systemfonts_1.0.4  pkgconfig_2.0.3   
#[29] htmltools_0.5.3    tidyselect_1.2.0   tibble_3.1.8       codetools_0.2-18  
#[33] viridisLite_0.4.1  fansi_1.0.3        crayon_1.5.2       withr_2.5.0       
#[37] later_1.3.0        SnowballC_0.7.0    grid_4.2.2         xtable_1.8-4      
#[41] gtable_0.3.1       lifecycle_1.0.3    magrittr_2.0.3     scales_1.2.1      
#[45] tokenizers_0.3.0   cli_3.4.1          stringi_1.7.8      farver_2.1.1      
#[49] promises_1.2.0.1   doParallel_1.0.17  ragg_1.2.4         ellipsis_0.3.2    
#[53] generics_0.1.3     vctrs_0.5.1        RColorBrewer_1.1-3 iterators_1.0.14  
#[57] tools_4.2.2        glue_1.6.2         purrr_0.3.5        parallel_4.2.2    
#[61] fastmap_1.1.0      survival_3.4-0     yaml_2.3.6         colorspace_2.0-3
